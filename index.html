<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease vs Rent - Advanced BI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        .card, .chartCard, .metric-card, input[type="range"], button {
            will-change: transform, box-shadow;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .gauge { transition: none !important; }
            .card, .chartCard {
                animation: none !important;
                transition: opacity 0.1ms, box-shadow 0.1ms, border-color 0.1ms !important;
            }
            .metric-card {
                animation: none !important;
                transition: background 0.1ms, border 0.1ms, transform 0.1ms !important;
            }
            input[type="range"]::-webkit-slider-thumb,
            input[type="range"]::-moz-range-thumb { transition: none !important; }
        }

        :root {
            --bg: #060d15;
            --card: #0e1a27;
            --card-rgb: 14, 26, 39;
            --text: #eaf2f9;
            --accent: #4db3ff;
            --muted: #94a8bd;
            --green: #2ecc71;
            --amber: #f1c40f;
            --red: #ff4d4d;
            --purple: #9b59b6;
            --border: #1a2a38;
            --cyan: #00d4ff;
            --orange: #ff8c3a;
        }

        body.light {
            --bg: #f8fafb;
            --card: #ffffff;
            --card-rgb: 255, 255, 255;
            --text: #0f172a;
            --accent: #1e40af;
            --muted: #475569;
            --border: #cbd5e1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1), color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            scroll-behavior: smooth;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
            animation: fadeInChart 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .logo {
            font-size: 26px;
            font-weight: 900;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: slideInLeft 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.4s ease;
            display: inline-block;
        }

        .logo:hover { filter: brightness(1.1); transform: translateX(4px); }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .toggle, .global-help-btn {
            background: var(--accent);
            color: #060d15;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .global-help-btn {
            padding: 8px 12px;
            background: rgba(77, 179, 255, 0.15);
            color: var(--accent);
            border: 1px solid rgba(77, 179, 255, 0.3);
            animation-delay: 0.1s;
        }

        .toggle:hover, .global-help-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(77, 179, 255, 0.3);
        }

        .card, .chartCard {
            background: linear-gradient(135deg, var(--card), rgba(30, 40, 50, 0.5));
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light .card, body.light .chartCard {
            background: #ffffff;
            border: 1.5px solid #d0dce6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.06);
        }

        .card.show, .chartCard.show { opacity: 1; transform: translateY(0); }

        .card:hover, .chartCard:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
            border-color: var(--accent);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 18px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }

        .card-icon { font-size: 22px; display: inline-flex; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        }

        .field { display: flex; flex-direction: column; gap: 6px; }
        .field-wrapper { display: flex; flex-direction: column; gap: 4px; }
        .field-label-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }

        label {
            font-size: 11px;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            flex: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        label:hover { color: var(--accent); }
        body.light label { color: #374151; }
        body.light label:hover { color: #1e40af; }

        .label-value {
            font-size: 12px;
            color: var(--accent);
            font-weight: 700;
            font-family: 'Courier New', monospace;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(77, 179, 255, 0.15);
            color: var(--accent);
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            border: 1px solid rgba(77, 179, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .info-btn:hover {
            background: rgba(77, 179, 255, 0.3);
            border-color: var(--accent);
            transform: scale(1.35) rotate(180deg);
            box-shadow: 0 6px 16px rgba(77, 179, 255, 0.25);
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; }

        input[type="text"], input[type="number"] {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: rgba(10, 24, 38, 0.5);
            color: var(--text);
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light input[type="text"], body.light input[type="number"] {
            background: #f9fafb;
            border: 1.5px solid #d1d5db;
            color: #0f172a;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card);
            box-shadow: 0 0 0 4px rgba(77, 179, 255, 0.15), 0 4px 12px rgba(77, 179, 255, 0.1);
            transform: translateY(-1px);
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, var(--border), var(--border));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: grab;
            padding: 8px 0;
            pointer-events: none;
            transition: background 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: grab;
            pointer-events: auto;
            box-shadow: 0 2px 8px rgba(77, 179, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--card);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: grab;
            border: 2px solid var(--card);
            box-shadow: 0 2px 8px rgba(77, 179, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .help-text, .field-hint, .section-description { display: none; }

        .gauge-section { text-align: center; padding: 16px 0; }
        .gaugeWrap { display: flex; justify-content: center; margin: 16px 0; }

        .gauge {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 32px rgba(77, 179, 255, 0.2);
            position: relative;
            background: conic-gradient(#4db3ff 0deg, #9b59b6 360deg);
        }

        .gaugeInner {
            width: 185px;
            height: 185px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 44px;
            font-weight: 900;
            box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .gauge-label { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 6px; }
        .gauge-interpretation { font-size: 14px; margin-top: 18px; color: var(--muted); line-height: 1.6; min-height: 48px; font-weight: 500; }

        .metricsBox {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .metric-card {
            background: rgba(77, 179, 255, 0.08);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(77, 179, 255, 0.15);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .metric-card:hover {
            background: rgba(77, 179, 255, 0.15);
            border-color: var(--accent);
            transform: translateY(-6px);
            box-shadow: 0 8px 24px rgba(77, 179, 255, 0.2);
        }

        .metric-label { font-size: 10px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.2px; margin-bottom: 8px; }
        .metric-value { font-size: 22px; font-weight: 900; color: var(--accent); letter-spacing: -0.5px; font-family: 'Courier New', monospace; }

        .chartCard { position: relative; }

        .chart-container { position: relative; height: 380px; margin-top: 12px; }

        canvas { max-height: 100% !important; }

        .chart-description {
            font-size: 12px;
            color: var(--muted);
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            line-height: 1.6;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(580px, 1fr));
            gap: 20px;
        }

        .chart-full { grid-column: 1 / -1; }

        @media (max-width: 1400px) { .charts-grid { grid-template-columns: 1fr; } }

        .comparison-table { width: 100%; margin-top: 16px; border-collapse: collapse; }
        .comparison-table th {
            background: rgba(77, 179, 255, 0.08);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            font-size: 11px;
            text-transform: uppercase;
            color: var(--accent);
            letter-spacing: 0.2px;
        }
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 500;
        }
        .comparison-table tr:hover { background: rgba(77, 179, 255, 0.06); }

        .metric-positive { color: var(--green); font-weight: 700; }
        .metric-negative { color: var(--red); font-weight: 700; }

        .section-header {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .divider { height: 1px; background: var(--border); margin: 20px 0; }

        .summary-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            padding: 16px;
            background: rgba(77, 179, 255, 0.05);
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .summary-item { display: flex; flex-direction: column; gap: 4px; padding: 8px; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .summary-item:hover { background: rgba(77, 179, 255, 0.1); transform: translateY(-2px); }
        .summary-label { font-size: 10px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.2px; }
        .summary-value { font-size: 15px; font-weight: 700; color: var(--accent); font-family: 'Courier New', monospace; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }

        .modal-content {
            background: rgba(var(--card-rgb), 0.95);
            backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(77, 179, 255, 0.2);
            border-radius: 12px;
            padding: 28px;
            max-width: 520px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        body.light .modal-content { background: rgba(255,255,255,0.98); }

        .modal-close {
            position: absolute;
            top: 16px; right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
            padding: 4px;
            width: 32px; height: 32px;
            border-radius: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-close:hover { color: var(--text); background: rgba(77,179,255,0.1); transform: rotate(90deg); }

        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text); padding-right: 32px; }
        .modal-subtitle { font-size: 13px; color: var(--muted); margin-bottom: 16px; line-height: 1.5; }
        .modal-section { margin-bottom: 16px; }
        .modal-section-title { font-size: 12px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 8px; }
        .modal-text { font-size: 13px; line-height: 1.6; color: var(--text); margin-bottom: 8px; }
        .modal-example { background: rgba(77,179,255,0.08); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent); font-size: 12px; color: var(--text); margin-top: 8px; }

        .info-banner {
            background: rgba(30,64,175,0.08);
            border: 1px solid rgba(30,64,175,0.2);
            border-left: 4px solid var(--accent);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text);
            line-height: 1.5;
        }

        .sensitivity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: rgba(77,179,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(77,179,255,0.1);
        }
        .sensitivity-label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.3px; }
        .sensitivity-chips { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }

        .sensitivity-chip {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            background: transparent;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sensitivity-chip:hover { border-color: var(--accent); background: rgba(77,179,255,0.1); transform: translateY(-2px); }
        .sensitivity-chip.active { background: var(--accent); color: #060d15; border-color: var(--accent); }

        .sensitivity-back-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1.5px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sensitivity-back-btn:hover { background: var(--accent); color: #060d15; }

        .sensitivity-chart-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--text); }

        /* VERDICT BANNER */
        .verdict-banner {
            border-radius: 16px;
            padding: 24px 28px;
            border: 2px solid transparent;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .verdict-banner.lease-wins { background: linear-gradient(135deg, rgba(46,204,113,0.12), rgba(0,212,255,0.08)); border-color: rgba(46,204,113,0.4); }
        .verdict-banner.rent-wins  { background: linear-gradient(135deg, rgba(255,77,77,0.12), rgba(255,140,58,0.08)); border-color: rgba(255,77,77,0.4); }
        .verdict-banner.neutral    { background: linear-gradient(135deg, rgba(241,196,15,0.12), rgba(255,140,58,0.08)); border-color: rgba(241,196,15,0.4); }

        .verdict-headline { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 10px; line-height: 1.3; }
        .verdict-body { font-size: 15px; color: var(--muted); line-height: 1.6; max-width: 780px; }
        .verdict-body strong { color: var(--text); }
        .verdict-stats { display: flex; gap: 24px; margin-top: 18px; flex-wrap: wrap; }
        .verdict-stat { display: flex; flex-direction: column; gap: 2px; }
        .verdict-stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); }
        .verdict-stat-value { font-size: 20px; font-weight: 800; font-family: 'Courier New', monospace; }
        .verdict-stat-value.positive { color: #2ecc71; }
        .verdict-stat-value.negative { color: #ff4d4d; }
        .verdict-stat-value.neutral  { color: #f1c40f; }
        .verdict-divider { width: 1px; background: var(--border); margin: 0 4px; }

        .share-btn {
            background: rgba(77,179,255,0.15);
            color: var(--accent);
            border: 1px solid rgba(77,179,255,0.3);
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .share-btn:hover { background: rgba(77,179,255,0.28); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(77,179,255,0.2); }

        .share-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 9999;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        .share-toast.show { transform: translateX(-50%) translateY(0); }

        @keyframes slideIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        .show { animation: slideIn 0.6s cubic-bezier(0.4,0,0.2,1) forwards !important; }
        @keyframes fadeInChart { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
        @keyframes slideInLeft { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }
        @keyframes slideInDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideInUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        .metric-value.updating { animation: valueFlash 0.6s cubic-bezier(0.4,0,0.2,1); }
        @keyframes valueFlash {
            0% { background: rgba(77,179,255,0.3); transform: scale(1); }
            50% { background: rgba(77,179,255,0.15); transform: scale(1.1); }
            100% { background: transparent; transform: scale(1); }
        }

        *:focus-visible { outline: 3px dashed var(--accent); outline-offset: 3px; }

        @media (max-width: 768px) {
            body { padding: 12px; }
            .container { gap: 14px; display: flex; flex-direction: column; }
            #verdictCard { order: 1; } #inputCard { order: 2; } #gaugeCard { order: 3; } #chartsSection { order: 4; } #tableCard { order: 5; }
            #inputsGrid { grid-template-columns: 1fr !important; gap: 16px !important; }
            .card, .chartCard { padding: 16px; }
            .gauge { width: 180px; height: 180px; }
            .gaugeInner { width: 145px; height: 145px; font-size: 36px; }
            .chart-container { height: 260px; }
            .header { flex-direction: column; gap: 12px; padding: 12px 0; }
            .charts-grid { grid-template-columns: 1fr; gap: 14px; }
            .metricsBox { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .summary-panel { grid-template-columns: repeat(2, 1fr); }
        }

    </style>
</head>

<body>

<div class="header">
    <div class="logo">üí∞ Aladdin Finance BI</div>
    <div class="header-actions">
        <button class="share-btn" onclick="shareScenario()" aria-label="Share this scenario">üì§ Share</button>
        <button class="global-help-btn" onclick="showGlobalHelp()" aria-label="Show help guide">‚ÑπÔ∏è Help</button>
        <button class="toggle" onclick="toggleTheme()" aria-label="Toggle between dark and light theme">
            <span id="theme-icon">üåô</span> <span id="theme-text">Dark</span>
        </button>
    </div>
</div>

<div class="container">

    <!-- INPUT PANEL -->
    <div class="card" id="inputCard">
        <div class="card-title"><span class="card-icon">‚öôÔ∏è</span>Financial Parameters</div>

        <div class="summary-panel">
            <div class="summary-item"><div class="summary-label">Asset Price</div><div class="summary-value" id="summaryAsset">‚Çπ20L</div></div>
            <div class="summary-item"><div class="summary-label">Loan Amount</div><div class="summary-value" id="summaryLoan">‚Çπ15L</div></div>
            <div class="summary-item"><div class="summary-label">Monthly Rent</div><div class="summary-value" id="summaryRent">‚Çπ45K</div></div>
            <div class="summary-item"><div class="summary-label">Lease Term</div><div class="summary-value" id="summaryTerm">20 yrs</div></div>
        </div>

        <div id="inputsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:12px;">

            <div>
                <div class="section-header"><span>üìã</span> Lease Components</div>
                <div class="grid">
                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Lease Amount (‚Çπ) <span class="label-value" id="leaseAmountLabel">‚Çπ2,000,000</span></label><button class="info-btn" onclick="showFieldHelp('leaseAmount')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="leaseAmount" type="text" value="2000000"><input type="range" id="leaseAmountRange" min="100000" max="5000000" step="50000" value="2000000"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Loan Amount (‚Çπ) <span class="label-value" id="loanAmountLabel">‚Çπ1,500,000</span></label><button class="info-btn" onclick="showFieldHelp('loanAmount')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="loanAmount" type="text" value="1500000"><input type="range" id="loanAmountRange" min="0" max="5000000" step="50000" value="1500000"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Interest Rate (%) <span class="label-value" id="loanRateLabel">8.5%</span></label><button class="info-btn" onclick="showFieldHelp('loanRate')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="loanRate" type="text" value="8.5"><input type="range" id="loanRateRange" min="1" max="20" step="0.1" value="8.5"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Maintenance (‚Çπ) <span class="label-value" id="maintenanceLabel">‚Çπ5,000</span></label><button class="info-btn" onclick="showFieldHelp('maintenance')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="maintenance" type="text" value="5000"><input type="range" id="maintenanceRange" min="0" max="20000" step="500" value="5000"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Withholding (%) <span class="label-value" id="withholdingLabel">0%</span></label><button class="info-btn" onclick="showFieldHelp('withholding')">‚ÑπÔ∏è</button></div>
                        <input id="withholding" type="text" value="0">
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Refund Delay (Mo) <span class="label-value" id="refundDelayLabel">0</span></label><button class="info-btn" onclick="showFieldHelp('refundDelay')">‚ÑπÔ∏è</button></div>
                        <input id="refundDelay" type="text" value="0">
                    </div></div>
                </div>
            </div>

            <div>
                <div class="section-header"><span>üè†</span> Rent Components</div>
                <div class="grid">
                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Market Rent (‚Çπ) <span class="label-value" id="marketRentLabel">‚Çπ45,000</span></label><button class="info-btn" onclick="showFieldHelp('marketRent')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="marketRent" type="text" value="45000"><input type="range" id="marketRentRange" min="5000" max="200000" step="1000" value="45000"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Rent Deposit (‚Çπ) <span class="label-value" id="rentDepositLabel">‚Çπ0</span></label><button class="info-btn" onclick="showFieldHelp('rentDeposit')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="rentDeposit" type="text" value="0"><input type="range" id="rentDepositRange" min="0" max="500000" step="10000" value="0"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Refund Delay (Mo) <span class="label-value" id="depositRefundDelayLabel">0</span></label><button class="info-btn" onclick="showFieldHelp('depositRefundDelay')">‚ÑπÔ∏è</button></div>
                        <input id="depositRefundDelay" type="text" value="0">
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Rent Growth (%) <span class="label-value" id="rentIncrementLabel">5%</span></label><button class="info-btn" onclick="showFieldHelp('rentIncrement')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="rentIncrement" type="text" value="5"><input type="range" id="rentIncrementRange" min="0" max="10" step="0.5" value="5"></div>
                    </div></div>

                    <div class="field"><div class="field-wrapper">
                        <div class="field-label-row"><label>Flexibility Value (‚Çπ/mo) <span class="label-value" id="flexibilityPremiumLabel">‚Çπ0</span></label><button class="info-btn" onclick="showFieldHelp('flexibilityPremium')">‚ÑπÔ∏è</button></div>
                        <div class="input-group"><input id="flexibilityPremium" type="text" value="0"><input type="range" id="flexibilityPremiumRange" min="0" max="20000" step="500" value="0"></div>
                    </div></div>
                </div>
            </div>

        </div>

        <div class="divider"></div>
        <div>
            <div class="section-header"><span>‚öñÔ∏è</span> Economic Assumptions</div>
            <div class="grid">
                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Lease Tenure (Mo) <span class="label-value" id="leaseTenureLabel">24</span></label><button class="info-btn" onclick="showFieldHelp('leaseTenure')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="leaseTenure" type="text" value="24"><input type="range" id="leaseTenureRange" min="12" max="360" step="12" value="24"></div>
                </div></div>

                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Loan Tenure (Mo) <span class="label-value" id="loanTenureLabel">24</span></label><button class="info-btn" onclick="showFieldHelp('loanTenure')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="loanTenure" type="text" value="24"><input type="range" id="loanTenureRange" min="12" max="360" step="12" value="24"></div>
                </div></div>

                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Opportunity Cost (%) <span class="label-value" id="oppRateLabel">12%</span></label><button class="info-btn" onclick="showFieldHelp('oppRate')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="oppRate" type="text" value="12"><input type="range" id="oppRateRange" min="1" max="20" step="0.1" value="12"></div>
                </div></div>

                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Net Lease Risk (%) <span class="label-value" id="riskPremiumLabel">1.5%</span></label><button class="info-btn" onclick="showFieldHelp('riskPremium')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="riskPremium" type="text" value="1.5"><input type="range" id="riskPremiumRange" min="0" max="10" step="0.1" value="1.5"></div>
                </div></div>

                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Inflation Rate (%) <span class="label-value" id="inflationRateLabel">6%</span></label><button class="info-btn" onclick="showFieldHelp('inflationRate')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="inflationRate" type="text" value="6"><input type="range" id="inflationRateRange" min="0" max="15" step="0.5" value="6"></div>
                </div></div>

                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Liquidity Premium (%) <span class="label-value" id="liquidityPremiumLabel">2%</span></label><button class="info-btn" onclick="showFieldHelp('liquidityPremium')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="liquidityPremium" type="text" value="2"><input type="range" id="liquidityPremiumRange" min="0" max="10" step="0.5" value="2"></div>
                </div></div>

                <div class="field"><div class="field-wrapper">
                    <div class="field-label-row"><label>Return Volatility (%) <span class="label-value" id="returnVolLabel">15%</span></label><button class="info-btn" onclick="showFieldHelp('returnVol')">‚ÑπÔ∏è</button></div>
                    <div class="input-group"><input id="returnVol" type="text" value="15"><input type="range" id="returnVolRange" min="0" max="40" step="1" value="15"></div>
                </div></div>
            </div>
        </div>
    </div>

    <!-- VERDICT BANNER -->
    <div class="card" id="verdictCard" style="padding:0;overflow:hidden;">
        <div class="verdict-banner neutral" id="verdictBanner">
            <div class="verdict-headline" id="verdictHeadline">‚è≥ Analyzing your inputs...</div>
            <div class="verdict-body" id="verdictBody">Enter your financial parameters above to receive a clear recommendation.</div>
            <div class="verdict-stats">
                <div class="verdict-stat">
                    <div class="verdict-stat-label">Monthly Savings</div>
                    <div class="verdict-stat-value neutral" id="verdictMonthlySaving">‚Äî</div>
                </div>
                <div class="verdict-divider"></div>
                <div class="verdict-stat">
                    <div class="verdict-stat-label">Total Term Savings</div>
                    <div class="verdict-stat-value neutral" id="verdictTermSaving">‚Äî</div>
                </div>
            </div>
        </div>
    </div>

    <!-- DECISION GAUGE & KPIs -->
    <div class="card" id="gaugeCard">
        <div class="card-title"><span class="card-icon">üìä</span>Decision Intelligence Score</div>
        <div class="gauge-section">
            <div class="gaugeWrap">
                <div id="gauge" class="gauge" role="img" aria-label="Decision score gauge">
                    <div class="gaugeInner"><span id="dial">0</span><div class="gauge-label">Score</div></div>
                </div>
            </div>
            <div class="gauge-interpretation" id="interpretation">Analyzing parameters...</div>
        </div>
        <div class="metricsBox">
            <div class="metric-card"><div class="metric-label">Monthly EMI</div><div id="mEMI" class="metric-value">‚Çπ0</div></div>
            <div class="metric-card"><div class="metric-label">Maintenance</div><div id="mMaintenance" class="metric-value">‚Çπ0</div></div>
            <div class="metric-card"><div class="metric-label">Monthly Gain</div><div id="mSave" class="metric-value">‚Çπ0</div></div>
            <div class="metric-card"><div class="metric-label">Annual Gain</div><div id="ySave" class="metric-value">‚Çπ0</div></div>
            <div class="metric-card"><div class="metric-label">Term Gain</div><div id="tSave" class="metric-value">‚Çπ0</div></div>
            <div class="metric-card"><div class="metric-label">Effective Cost</div><div id="mEffective" class="metric-value">‚Çπ0</div></div>
            <div class="metric-card"><div class="metric-label">Confidence</div><div id="confidence" class="metric-value">0%</div></div>
        </div>
    </div>

    <!-- CHARTS SECTION -->
    <div class="charts-grid" id="chartsSection">

        <div style="grid-column:1/-1;margin-bottom:12px;">
            <div class="info-banner" style="margin:0;">
                <strong>üìä About the Charts:</strong> <strong>TCO Chart</strong> shows cost components. <strong>Monthly Comparison</strong> compares direct outflows. <strong>Cumulative Impact</strong> shows total spending over time. Study the spread between lease and rent lines.
            </div>
        </div>

        <div class="chartCard">
            <div class="card-title"><span class="card-icon">üíæ</span>Total Economic Cost Drivers</div>
            <div class="chart-container"><canvas id="tcoChart"></canvas></div>
            <div class="chart-description">All lease cost components: interest, opportunity costs, maintenance, withholding, and delays.</div>
        </div>

        <div class="chartCard">
            <div class="card-title"><span class="card-icon">üí∞</span>Monthly Cost Comparison</div>
            <div class="chart-container"><canvas id="monthlyCostChart"></canvas></div>
            <div class="chart-description">Direct comparison of monthly outflows: risk-adjusted lease cost vs. market rent.</div>
        </div>

        <div class="chartCard chart-full">
            <div class="card-title"><span class="card-icon">üìà</span>Cumulative Cost Impact Over Time</div>
            <div class="chart-container"><canvas id="cumulativeImpactChart"></canvas></div>
            <div class="chart-description">Total accumulated costs. The spread between lines is your financial advantage.</div>
        </div>

        <div class="chartCard">
            <div class="card-title"><span class="card-icon">üî•</span>Decision Robustness Matrix</div>
            <div class="chart-container"><canvas id="sensitivityChart"></canvas></div>
            <div class="chart-description">How does the outcome change with rent variations? Red = Lease advantage. Axis shows rent change %.</div>
        </div>

        <div class="chartCard">
            <div class="card-title"><span class="card-icon">ü•ß</span>Economic Cost Distribution</div>
            <div class="chart-container"><canvas id="costCompositionChart"></canvas></div>
            <div class="chart-description">Which cost categories dominate: Interest, Opportunity costs, Maintenance, Withholding, Delays, Net Lease Risk.</div>
        </div>

        <div class="chartCard">
            <div class="card-title"><span class="card-icon">üìä</span>Rent Growth vs Fixed Lease</div>
            <div id="rentInsightBar" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
                <div style="background:rgba(46,204,113,0.12);border:1px solid rgba(46,204,113,0.3);border-radius:8px;padding:8px 14px;flex:1;min-width:120px;">
                    <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--green);margin-bottom:4px;">Monthly Saving (M1)</div>
                    <div id="rentStatMonthly" style="font-size:18px;font-weight:800;font-family:'Courier New',monospace;color:var(--text);">‚Äî</div>
                </div>
                <div style="background:rgba(77,179,255,0.1);border:1px solid rgba(77,179,255,0.25);border-radius:8px;padding:8px 14px;flex:1;min-width:120px;">
                    <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent);margin-bottom:4px;">Cumulative Saving (Total)</div>
                    <div id="rentStatCumulative" style="font-size:18px;font-weight:800;font-family:'Courier New',monospace;color:var(--text);">‚Äî</div>
                </div>
                <div style="background:rgba(155,89,182,0.1);border:1px solid rgba(155,89,182,0.25);border-radius:8px;padding:8px 14px;flex:1;min-width:120px;">
                    <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--purple);margin-bottom:4px;">Saving at Final Month</div>
                    <div id="rentStatFinal" style="font-size:18px;font-weight:800;font-family:'Courier New',monospace;color:var(--text);">‚Äî</div>
                </div>
                <div id="rentCrossoverPill" style="background:rgba(241,196,15,0.1);border:1px solid rgba(241,196,15,0.25);border-radius:8px;padding:8px 14px;flex:1;min-width:120px;display:none;">
                    <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--amber);margin-bottom:4px;">Rent Overtakes Lease At</div>
                    <div id="rentStatCrossover" style="font-size:18px;font-weight:800;font-family:'Courier New',monospace;color:var(--text);">‚Äî</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="rentProjectionChart"></canvas></div>
            <div class="chart-description">Green fill = monthly saving zone where leasing costs less than renting. Right axis tracks cumulative net savings.</div>
        </div>

        <div class="chartCard">
            <div class="card-title"><span class="card-icon">üéØ</span><span id="sensitivityTitle">What Changes Your Monthly Savings Most</span></div>

            <div id="sensitivityOverviewMode">
                <div class="sensitivity-controls">
                    <span class="sensitivity-label">Explore Factor:</span>
                    <div class="sensitivity-chips">
                        <button class="sensitivity-chip" onclick="switchSensitivityMode('Market Rent')">Market Rent</button>
                        <button class="sensitivity-chip" onclick="switchSensitivityMode('Interest Rate')">Interest Rate</button>
                        <button class="sensitivity-chip" onclick="switchSensitivityMode('Loan Amount')">Loan Amount</button>
                        <button class="sensitivity-chip" onclick="switchSensitivityMode('Maintenance')">Maintenance</button>
                        <button class="sensitivity-chip" onclick="switchSensitivityMode('Rent Growth')">Rent Growth</button>
                    </div>
                </div>
                <div class="chart-description" style="margin-bottom:12px;">Right = more savings, Left = less savings. Based on ¬±10% change.</div>
            </div>

            <div id="sensitivityInteractiveMode" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span class="sensitivity-chart-title" id="interactiveTitle"></span>
                    <button class="sensitivity-back-btn" onclick="switchSensitivityMode()">‚Üê Back to Overview</button>
                </div>
            </div>

            <div class="chart-container"><canvas id="sensitivityHeatmapChart"></canvas></div>
        </div>

        <div class="chartCard chart-full">
            <div class="card-title"><span class="card-icon">üìä</span>Loan Payment Breakdown Over Time</div>
            <div class="chart-container"><canvas id="amortizationChart"></canvas></div>
            <div class="chart-description">Stacked bars show principal vs. interest portions of each EMI. Line shows remaining loan balance declining over time.</div>
        </div>

    </div>

    <!-- COMPARISON TABLE -->
    <div class="card" id="tableCard">
        <div class="card-title"><span class="card-icon">üìã</span>Financial Summary</div>
        <table class="comparison-table">
            <thead>
                <tr><th>Metric</th><th>Lease (Economic Cost)</th><th>Market Rent</th><th>Advantage</th></tr>
            </thead>
            <tbody id="comparisonBody"></tbody>
        </table>
    </div>

</div>

<!-- HELP MODAL -->
<div class="modal-overlay" id="helpModal" onclick="closeHelpModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeHelpModal()">‚úï</button>
        <div id="helpContent"></div>
    </div>
</div>

<div class="share-toast" id="shareToast">‚úÖ Link copied to clipboard!</div>

<script>
Chart.register(window['ChartDataLabels']);

/* ================= SHARE / LOAD FROM URL ================= */
const SHARE_PARAMS = [
    'leaseAmount','loanAmount','loanRate','loanTenure','leaseTenure',
    'maintenance','withholding','refundDelay',
    'marketRent','rentDeposit','depositRefundDelay','rentIncrement','flexibilityPremium',
    'oppRate','riskPremium','inflationRate','liquidityPremium','returnVol'
];

function shareScenario() {
    const params = new URLSearchParams();
    SHARE_PARAMS.forEach(id => { const el = document.getElementById(id); if (el) params.set(id, el.value); });
    const url = window.location.origin + window.location.pathname + '?' + params.toString();
    navigator.clipboard.writeText(url).then(() => {
        const toast = document.getElementById('shareToast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2800);
    }).catch(() => { prompt('Copy this link:', url); });
}

function loadFromURL() {
    const params = new URLSearchParams(window.location.search);
    SHARE_PARAMS.forEach(id => {
        if (params.has(id)) {
            const el = document.getElementById(id);
            const rangeEl = document.getElementById(id + 'Range');
            if (el) el.value = params.get(id);
            if (rangeEl) rangeEl.value = params.get(id);
        }
    });
}

/* ================= THEME ================= */
function toggleTheme() {
    const isDark = !document.body.classList.contains('light');
    document.body.classList.toggle('light');
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
    updateThemeUI();
    setTimeout(() => {
        const colors = getChartColors();
        [tcoChart, monthlyCostChart, cumulativeImpactChart, sensitivityChart,
         costCompositionChart, rentProjectionChart, sensitivityHeatmapChart, amortizationChart]
        .forEach(c => { if (c) c.update(); });
    }, 100);
}

function updateThemeUI() {
    const isDark = !document.body.classList.contains('light');
    document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    document.getElementById('theme-text').textContent = isDark ? 'Dark' : 'Light';
}

if (localStorage.getItem('theme') === 'light') { document.body.classList.add('light'); updateThemeUI(); }

/* ================= SCROLL REVEAL ================= */
const observer = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('show'); });
}, { threshold: 0.1 });
document.querySelectorAll('.card, .chartCard').forEach(el => observer.observe(el));

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);

function cleanNumber(v) { return parseFloat((v || '').replace(/[,%\s‚Çπ]/g, '')) || 0; }
function num(id) { const val = cleanNumber($(id).value); return isNaN(val) ? 0 : val; }
function formatINR(n) { n = Math.max(0, Number(n) || 0); return '‚Çπ' + Math.round(n).toLocaleString('en-IN'); }
function formatPercent(n) { n = Number(n) || 0; return Number(n).toLocaleString('en-IN', { maximumFractionDigits: 2 }) + '%'; }

function getChartColors() {
    const isDark = !document.body.classList.contains('light');
    return {
        text: isDark ? '#eaf2f9' : '#0b1622',
        muted: isDark ? '#94a8bd' : '#5c6c7a',
        border: isDark ? '#1a2a38' : '#e0e8f0',
        card: isDark ? '#0e1a27' : '#ffffff',
        primary: '#4db3ff', secondary: '#9b59b6', success: '#2ecc71',
        danger: '#ff4d4d', warning: '#f1c40f', cyan: '#00d4ff', orange: '#ff8c3a'
    };
}

/* ================= HELP MODAL ================= */
const fieldHelp = {
    leaseAmount: {
        title: 'Lease Amount',
        subtitle: 'The total market value of the property or asset ‚Äî not the deposit, not the loan. The full price as if you were buying it outright.',
        sections: [
            { title: 'What it is', text: 'This is the sticker price of what you are leasing. Every other cost in the model ‚Äî interest, opportunity cost, withholding, risk ‚Äî is calculated as a fraction of this. Getting it right matters.' },
            { title: 'For residential users', text: 'If you are a salaried individual deciding whether to lease a flat in Bengaluru for ‚Çπ50L market value, enter ‚Çπ50,00,000. Self-employed? You might be leasing a shop-cum-residence worth ‚Çπ80L ‚Äî enter the full property value, not just the deposit you paid.' },
            { title: 'Examples by profile', example: 'Salaried, 2BHK flat (Bengaluru/Pune): ‚Çπ50L‚Äì‚Çπ1.2Cr | Self-employed, shop or studio apartment: ‚Çπ30L‚Äì‚Çπ80L | Commercial space (SME): ‚Çπ50L‚Äì‚Çπ5Cr' },
            { title: 'Common mistake', text: 'People often enter the deposit amount here instead of the full value. If the lessor took ‚Çπ5L as deposit on a ‚Çπ50L property, that is only 10% of the asset. Entering ‚Çπ5L would understate all costs by 10√ó.' }
        ]
    },
    loanAmount: {
        title: 'Loan Amount',
        subtitle: 'The portion of the lease financed through a bank or lender ‚Äî the rest is your own money bearing an opportunity cost.',
        sections: [
            { title: 'What it is', text: 'Most people do not pay the full lease deposit from savings. They borrow part of it, or take a personal/LAP loan against the arrangement. This is the borrowed portion. The difference ‚Äî what you bring yourself ‚Äî is your own capital, and the model charges you opportunity cost for locking it up.' },
            { title: 'For salaried individuals', text: 'If you took a personal loan of ‚Çπ5L to fund part of a ‚Çπ8L lease deposit, enter ‚Çπ5L here. The remaining ‚Çπ3L came from your savings ‚Äî that ‚Çπ3L is what the model will charge opportunity cost on. No loan? Set this to zero and the entire lease amount bears opportunity cost.' },
            { title: 'For self-employed', text: 'Business owners often use a working capital line, OD facility, or LAP to fund a lease. Enter the borrowed portion here. If you self-funded the entire deposit from business reserves, enter zero ‚Äî and set your opportunity rate to your business return rate.' },
            { title: 'Example', example: 'Lease Amount ‚Çπ20L, Loan ‚Çπ15L ‚Üí Own funds = ‚Çπ5L tied up. Model charges opp cost on ‚Çπ5L for the full lease term. Loan ‚Çπ0 ‚Üí Full ‚Çπ20L bears opp cost.' }
        ]
    },
    loanRate: {
        title: 'Loan Interest Rate',
        subtitle: 'The annual rate your lender charges on the borrowed portion ‚Äî directly sets your monthly EMI.',
        sections: [
            { title: 'What it is', text: 'The APR on your loan, expressed annually. The model converts to monthly internally and uses a reducing-balance EMI formula. Even 1% difference significantly changes total interest over long tenures.' },
            { title: 'For salaried individuals', text: 'Salaried borrowers with good CIBIL (750+) typically get the best rates on personal or home loans. If you are using a top-up home loan to fund a lease, the rate is close to your home loan rate. Personal loans for lease funding are more expensive.' },
            { title: 'For self-employed', text: 'Self-employed borrowers often face higher rates due to income documentation complexity. A GST-filed, ITR-consistent business can get near-salaried rates; cash-heavy businesses may pay 2‚Äì4% more.' },
            { title: 'Current India benchmarks (2024‚Äì25)', example: 'Home loan / top-up: 8.5‚Äì9.5% | Personal loan (salaried): 10‚Äì14% | LAP (self-employed): 9‚Äì13% | NBFC / business loan: 12‚Äì18%' }
        ]
    },
    maintenance: {
        title: 'Monthly Maintenance',
        subtitle: 'Ongoing costs to keep the property usable ‚Äî separate from your EMI.',
        sections: [
            { title: 'What it is', text: 'Leases often put upkeep responsibility on the lessee. This is your monthly spend on top of EMI to keep the asset in working condition ‚Äî repairs, society charges, minor fixes, servicing.' },
            { title: 'For salaried individuals (residential)', text: 'In a residential lease, you typically pay society maintenance charges (‚Çπ2,000‚Äì‚Çπ8,000/month depending on the apartment). If the property needs minor repairs you bear ‚Äî add those. Exclude utility bills (electricity, water) as those are not lease costs.' },
            { title: 'For self-employed (shop/workspace)', text: 'Commercial leases usually assign all interior and equipment maintenance to the lessee. Budget AMC for AC and electrical, minor civil works, cleaning staff, and periodic painting. This can easily reach ‚Çπ5,000‚Äì‚Çπ20,000/month depending on size.' },
            { title: 'Examples', example: 'Salaried, 2BHK apartment society charge: ‚Çπ3,000‚Äì‚Çπ8,000 | Self-employed, 500 sq ft shop: ‚Çπ4,000‚Äì‚Çπ10,000 | Industrial / large commercial: ‚Çπ10,000‚Äì‚Çπ30,000+' }
        ]
    },
    withholding: {
        title: 'Lease Withholding %',
        subtitle: 'The share of your deposit you realistically expect never to get back ‚Äî deducted by the lessor for damages, restoration, or disputes.',
        sections: [
            { title: 'What it is', text: 'Most leases allow deductions from the security deposit at exit. This is your honest estimate of what percentage you will lose. The model treats it as a permanent economic loss ‚Äî money gone, not returned.' },
            { title: 'For salaried individuals (residential)', text: 'Residential lessors frequently deduct for painting, cleaning, and minor fixtures. If you live neatly and document the condition on entry and exit, 2‚Äì5% is typical. If you made modifications (built-in furniture, drilling) or there is wear from children/pets, expect 5‚Äì10%.' },
            { title: 'For self-employed (shop/office)', text: 'Commercial tenants who install equipment, modify interiors, or run heavy operations face larger deductions. Restoration clauses can be severe ‚Äî a gut-fit shop may cost ‚Çπ2‚Äì5L to restore. Budget 5‚Äì15% or get a written waiver upfront.' },
            { title: 'Examples', example: 'Careful residential tenant, clean exit: 0‚Äì3% | Typical residential with normal wear: 3‚Äì7% | Commercial with fit-outs or modifications: 7‚Äì20%' }
        ]
    },
    refundDelay: {
        title: 'Lease Refund Delay',
        subtitle: 'Months after you vacate before the deposit actually lands in your account.',
        sections: [
            { title: 'What it is', text: 'Even a rightful refund takes time. While you wait, your capital sits idle. The model charges you opportunity cost for every month of delay ‚Äî using your locked funds rate.' },
            { title: 'For salaried individuals', text: 'Individual residential landlords are the slowest refunders ‚Äî they often wait until they find a new tenant or complete inspection. 1‚Äì3 months is common. Institutional lessors (housing cos, REITs) are faster, often within 30 days. If you have had a bad experience before, set this to 3.' },
            { title: 'For self-employed', text: 'Commercial deposits are larger, so disputes are more common and financially motivated. A ‚Çπ10L commercial deposit delayed 4 months at 12% opportunity cost = ‚Çπ40,000 in lost returns. Budget 2‚Äì4 months unless you have a strong written agreement.' },
            { title: 'Real cost example', example: 'Deposit ‚Çπ5L, delay 3 months, opp rate 12% ‚Üí ‚Çπ15,000 lost | Deposit ‚Çπ20L, delay 4 months ‚Üí ‚Çπ80,000 lost' }
        ]
    },
    marketRent: {
        title: 'Market Rent',
        subtitle: 'What you would pay monthly if you rented the same property instead of leasing ‚Äî your true alternative.',
        sections: [
            { title: 'What it is', text: 'The cornerstone of the comparison. Month 1 rent of an equivalent property. The model escalates this annually using your Rent Growth input and compares cumulative rent against total lease cost.' },
            { title: 'For salaried individuals', text: 'Look at NoBroker, 99Acres, or MagicBricks for comparable 2/3BHK flats in the same locality and size range. Use recently transacted rents from broker conversations, not listed asking prices ‚Äî transacted rents are typically 8‚Äì12% lower. Include any amenities premium.' },
            { title: 'For self-employed', text: 'Compare like-for-like. If your lease is a 600 sq ft shop on MG Road, find what comparable shops rent for in the same stretch. Location, floor, and frontage matter enormously in commercial rent ‚Äî get 2‚Äì3 broker quotes.' },
            { title: 'Residential benchmarks (2024)', example: 'Bengaluru (Whitefield, 2BHK): ‚Çπ28,000‚Äì‚Çπ45,000 | Mumbai (Andheri, 2BHK): ‚Çπ55,000‚Äì‚Çπ85,000 | Delhi NCR (Gurgaon, 2BHK): ‚Çπ35,000‚Äì‚Çπ60,000 | Pune (Kothrud, 2BHK): ‚Çπ20,000‚Äì‚Çπ35,000' }
        ]
    },
    rentDeposit: {
        title: 'Rent Deposit',
        subtitle: 'Upfront security deposit you would pay to a landlord under a rental agreement ‚Äî refundable but capital-locked.',
        sections: [
            { title: 'What it is', text: 'Landlords require a deposit before handing over keys. It earns nothing for you. The model charges you opportunity cost on this amount for the full comparison period.' },
            { title: 'For salaried individuals', text: 'Residential deposits in India are typically 2‚Äì3 months rent in most cities, but can reach 10 months in some parts of Karnataka (old-style 11-month agreements with large deposits are still common). Know your local norm before entering.' },
            { title: 'For self-employed', text: 'Commercial rental deposits are 3‚Äì6 months of rent, sometimes more for prime locations. Co-working spaces may ask only 1 month or zero. If you are comparing a lease against a co-working option, enter a much lower deposit here.' },
            { title: 'City norms', example: 'Bengaluru residential: 5‚Äì10 months rent (higher end common) | Mumbai residential: 2‚Äì3 months | Delhi/NCR: 2‚Äì3 months | Pune: 2‚Äì4 months | Commercial pan-India: 3‚Äì6 months' }
        ]
    },
    depositRefundDelay: {
        title: 'Rent Deposit Refund Delay',
        subtitle: 'Months after vacating before your rental deposit is returned.',
        sections: [
            { title: 'What it is', text: 'Rental deposits also take time to return. The model prices this using your opportunity rate ‚Äî money sitting with the landlord is not working for you.' },
            { title: 'For salaried individuals', text: 'Most residential landlords return within 1‚Äì2 months after inspection and key handover. Disputes over painting and cleaning are common. If you leave a paper trail (condition photos, written communication), refunds are faster. Use 1‚Äì2 months as a realistic default.' },
            { title: 'For self-employed', text: 'Commercial refunds depend heavily on the agreement and landlord type. High-street retail landlords can be difficult ‚Äî disputes over restoration, signage removal, and fit-out damage are common. Use 2‚Äì3 months if the deposit is substantial.' },
            { title: 'Tip', text: 'Since rent deposits are usually smaller than lease deposits, the financial impact of this delay is modest. But if you are in a high-deposit city (like Bengaluru with 8‚Äì10 months deposit), a 2-month delay on a large deposit genuinely costs money.' }
        ]
    },
    rentIncrement: {
        title: 'Annual Rent Growth',
        subtitle: 'How much your rent escalates each year ‚Äî a key reason leasing can beat renting over time.',
        sections: [
            { title: 'What it is', text: 'Rent rarely stays flat. The model escalates your Month 1 rent by this percentage every 12 months. Higher growth makes renting progressively more expensive versus a fixed lease cost.' },
            { title: 'For salaried individuals', text: 'Residential rents in Bengaluru, Hyderabad and Mumbai have been growing 8‚Äì12%/year in premium areas post-2022. If you are in a high-demand neighbourhood and your landlord historically raises rent steeply, use 7‚Äì10%. More stable areas: 4‚Äì6%. Check your last 2‚Äì3 renewal experiences.' },
            { title: 'For self-employed', text: 'Commercial rents in high-street and business park locations follow market cycles more than inflation. In a supply-constrained market (e.g., lower Parel, Connaught Place), 6‚Äì10% is realistic. In oversupplied suburban commercial, 3‚Äì5% or even flat is common.' },
            { title: 'Why this matters', example: 'Rent ‚Çπ40,000 at 8% growth ‚Üí Year 5 rent = ‚Çπ58,773. Over 5 years you pay ‚Çπ26.5L in total rent. At 4% growth, only ‚Çπ23.5L. That ‚Çπ3L difference changes the lease vs rent verdict.' }
        ]
    },
    flexibilityPremium: {
        title: 'Flexibility Value',
        subtitle: 'The monthly ‚Çπ value of renting\'s freedom to exit ‚Äî something a long lease cannot offer.',
        sections: [
            { title: 'What it is', text: 'Renting lets you exit with short notice. A lease locks you in ‚Äî breaking it usually means deposit forfeiture or penalties. This field lets you put a price on that optionality. The model subtracts it from renting\'s monthly cost, making renting look cheaper on a like-for-like basis.' },
            { title: 'For salaried individuals', text: 'Are you likely to change cities for work? Is your job stable? If you are in a transferable role (IT services, banking, defence, government) or early in your career, the ability to move without penalty is worth real money. A ‚Çπ3,000‚Äì‚Çπ8,000/month value is reasonable for salaried professionals with job mobility.' },
            { title: 'For self-employed', text: 'If your business is in early stage ‚Äî revenues not yet stable, location not proven ‚Äî the ability to exit a shop or office without losing a large deposit has high value. If you have been at the same location for 10 years and plan 10 more, it is worth very little. Calibrate to your actual uncertainty.' },
            { title: 'Calibration guide', example: 'Salaried, frequent relocations or unstable job: ‚Çπ5,000‚Äì‚Çπ10,000 | Salaried, stable, settled city: ‚Çπ1,000‚Äì‚Çπ3,000 | Self-employed, early stage: ‚Çπ5,000‚Äì‚Çπ12,000 | Self-employed, established, location-dependent: ‚Çπ0‚Äì‚Çπ2,000' }
        ]
    },
    leaseTenure: {
        title: 'Lease Tenure',
        subtitle: 'The total length of your lease in months ‚Äî sets the time horizon for the entire comparison.',
        sections: [
            { title: 'What it is', text: 'How long you commit to the lease, in months. All costs and savings are computed across this period. Longer tenure generally favours leasing as rent escalation compounds, but also increases your total commitment risk.' },
            { title: 'For salaried individuals', text: 'Residential leases in India are typically 11‚Äì24 months (11-month is standard to avoid registration). A long-term residential lease (36‚Äì60 months) is uncommon but exists, especially in corporate housing. If you are modelling an 11-month renewable agreement, enter 24 or 36 to model your likely total stay.' },
            { title: 'For self-employed', text: 'Commercial leases run 36‚Äì60 months for standard retail/office, and 120‚Äì180 months for anchor tenants or industrial. Shorter tenures favour renting; longer tenures where rent growth is high strongly favour leasing because the escalating rent compounds significantly.' },
            { title: 'Rule of thumb', text: 'Below 18 months, leasing rarely wins unless the deposit is very small. Beyond 36 months in a 6%+ rent growth market, leasing almost always wins if your lease deposit cost is reasonable. Use the Cumulative Impact chart to see exactly when the crossover happens for your inputs.' }
        ]
    },
    loanTenure: {
        title: 'Loan Tenure',
        subtitle: 'How long your loan repayment runs ‚Äî shorter than the lease creates a rent-free EMI tail period.',
        sections: [
            { title: 'What it is', text: 'How many months you repay your loan. Longer = lower EMI but more total interest. The model caps this at the lease tenure ‚Äî you cannot repay a loan longer than the lease. If loan tenure is shorter than lease, you get an EMI-free period at the end.' },
            { title: 'For salaried individuals', text: 'If you used a personal loan to fund a lease deposit, the loan tenure is typically 12‚Äì36 months. On a 24-month lease with a 12-month loan, you get 12 months EMI-free. That significantly reduces your average monthly cost and often swings the decision.' },
            { title: 'For self-employed', text: 'Business loans or OD facilities used to fund commercial leases often have shorter tenures (12‚Äì36 months). Matching a 3-year loan against a 5-year lease gives you 2 EMI-free years ‚Äî a substantial benefit. Some business owners accelerate repayment using business cash flows, shortening the effective tenure further.' },
            { title: 'Example', example: 'Salaried: 12-month personal loan, 24-month lease ‚Üí 12 months EMI-free. Self-employed: 24-month business loan, 60-month lease ‚Üí 36 months EMI-free ‚Äî strongly improves lease economics.' }
        ]
    },
    oppRate: {
        title: 'Opportunity Cost Rate',
        subtitle: 'What your locked capital could have earned elsewhere ‚Äî enter the nominal (pre-inflation) annual return.',
        sections: [
            { title: 'What it is', text: 'Capital tied up in a lease deposit cannot be invested. This is the return you give up. The model compounds this over the lease term and treats it as a cost of leasing. Higher rate = leasing looks more expensive.' },
            { title: 'For salaried individuals', text: 'Think about where you would actually put the money. Most salaried investors spread across FDs, equity mutual funds, and PPF. A blended rate of 9‚Äì12% is realistic for a balanced investor. If you are conservative (mostly FDs and debt funds), use 7‚Äì8%. If you are aggressive (mostly equity), use 12‚Äì15%.' },
            { title: 'For self-employed', text: 'This is where self-employed users often have a much higher rate ‚Äî business capital earns 20‚Äì30%+ returns for profitable businesses. If you are taking money out of your business to fund a lease deposit, the opportunity cost is your business return rate, not an FD rate. This makes large lease deposits especially expensive for self-employed users.' },
            { title: 'Benchmarks', example: 'Conservative salaried (FD + PPF): 7‚Äì8% | Balanced salaried (equity + debt mix): 10‚Äì12% | Aggressive investor: 13‚Äì16% | Self-employed, profitable business: 18‚Äì30%' }
        ]
    },
    riskPremium: {
        title: 'Net Lease Risk Premium',
        subtitle: 'Extra annual % to account for the risks of leasing that renting does not carry ‚Äî counterparty, lock-in, and deposit recovery risk.',
        sections: [
            { title: 'What it is', text: 'Leasing ties up a large deposit with one person for years, with limited exit options. Renting is more flexible and deposits are smaller. This captures only the net excess risk of leasing over renting ‚Äî not total risk.' },
            { title: 'For salaried individuals (residential)', text: 'The main risks are: landlord refuses to refund, landlord sells property mid-lease forcing you out, or disputes at exit. An individual landlord with a verbal agreement is high risk. A corporate housing provider with escrow is low risk. Most residential scenarios fall in the 1‚Äì2% range.' },
            { title: 'For self-employed (commercial)', text: 'Commercial lease risks are higher ‚Äî deposits are larger, disputes are financially motivated, and court recovery is slow. If your deposit is ‚Çπ15L+ with an individual landlord and no bank guarantee, use 2‚Äì3%. REIT-owned buildings with legal departments and track records: 0.5‚Äì1%.' },
            { title: 'Calibration', example: 'Institutional/REIT lessor, strong documentation: 0.5‚Äì1% | Reputed developer, standard agreement: 1‚Äì1.5% | Individual landlord, moderate documentation: 1.5‚Äì2.5% | Informal, weak agreement, large deposit: 3‚Äì5%' }
        ]
    },
    inflationRate: {
        title: 'Inflation Rate',
        subtitle: 'Expected annual inflation ‚Äî converts your nominal opportunity rate to a real, purchasing-power-adjusted rate. Does not escalate rent.',
        sections: [
            { title: 'What it is', text: 'Inflation erodes the value of money. This field lets the model express opportunity costs in real terms. A 12% nominal return in a 6% inflation environment is only ~5.7% real ‚Äî and that is what should price the cost of locking your capital.' },
            { title: 'For salaried individuals', text: 'Use the inflation rate you believe will persist over your lease term. If you are conservative, use the RBI target of 4‚Äì5%. If you expect higher due to urban cost pressures (housing, food, services), use 5.5‚Äì6.5%. This mainly affects how much weight the model gives to opportunity cost.' },
            { title: 'Important: this does NOT escalate rent', text: 'Rent growth is a separate input. Set Inflation here for opportunity cost adjustment only. Even if inflation is 6%, your landlord might raise rent 10% (high demand) or 2% (oversupply). Enter each independently.' },
            { title: 'Reference', example: 'RBI inflation target: 4% | CPI average 2022‚Äì24: 5.5‚Äì6.5% | Conservative long-run forecast: 4.5‚Äì5% | Urban services inflation (anecdotal): 6‚Äì8%' }
        ]
    },
    liquidityPremium: {
        title: 'Liquidity Premium',
        subtitle: 'Extra % added to the opportunity rate for lease deposit funds ‚Äî because money locked for years is less accessible than money locked for months.',
        sections: [
            { title: 'What it is', text: 'A rent deposit (2‚Äì3 months, small amount) can be recovered quickly if needed. A lease deposit (large, locked for years) cannot be easily accessed, borrowed against, or redeployed. This premium compensates for that extra illiquidity ‚Äî applied only to the lease deposit, not the rent deposit.' },
            { title: 'For salaried individuals', text: 'If the lease deposit is a meaningful chunk of your savings (say, ‚Çπ10L out of ‚Çπ25L in savings), the liquidity premium should be higher ‚Äî you genuinely cannot access that money in an emergency. If you are cash-rich and this deposit is minor relative to your net worth, lower it.' },
            { title: 'For self-employed', text: 'Business owners with working capital needs feel illiquidity more acutely. ‚Çπ15L locked in a lease deposit could fund inventory, clear a supplier, or hire staff. Use 2.5‚Äì4% if this capital has clear business uses.' },
            { title: 'How to set it', example: 'Deposit is <10% of liquid savings / net worth: 0.5‚Äì1% | Deposit is 10‚Äì25% of savings: 1.5‚Äì2.5% | Deposit is >25% of savings or has high business opportunity cost: 2.5‚Äì4%' }
        ]
    },
    returnVol: {
        title: 'Return Volatility',
        subtitle: 'How unpredictable your investment returns are ‚Äî higher uncertainty reduces how much you can rely on the opportunity cost argument.',
        sections: [
            { title: 'What it is', text: 'If you say "I could earn 14% in equity funds," but your actual returns swing from ‚àí15% to +35%, you cannot count on 14% reliably. This field applies a certainty-equivalent downward adjustment to your opportunity rate to reflect that. Higher volatility = lower reliable effective rate = leasing looks slightly more attractive.' },
            { title: 'For salaried individuals', text: 'Most salaried investors are in a mix of equity and debt. Pure equity investors face real volatility ‚Äî returns depend on when you invest and when you need the money. If your alternative is a pure FD or debt fund, use 5%. If it is ELSS or index funds, use 14‚Äì18%. If you are comparing against a specific SIP, use the volatility of that fund category.' },
            { title: 'For self-employed', text: 'Business returns are highly volatile ‚Äî a profitable year can be followed by a lean one. If your opportunity rate is your business return (say 25%), the volatility of that return is also high. Use 25‚Äì35% volatility in such cases. This will modestly reduce the effective opportunity rate, making the large lease deposit seem less costly.' },
            { title: 'Quick reference', example: 'FD / liquid fund / PPF: 3‚Äì5% | Debt mutual funds: 5‚Äì8% | Balanced / hybrid funds: 10‚Äì14% | Nifty 50 index: 15‚Äì18% | Mid/small cap equity: 22‚Äì30% | Business returns: 25‚Äì40%' }
        ]
    }
};

function showFieldHelp(fieldId) {
    const help = fieldHelp[fieldId] || { title: 'Help', subtitle: '' };
    let html = `<div class="modal-title">${help.title}</div><div class="modal-subtitle">${help.subtitle}</div>`;
    (help.sections || []).forEach(s => {
        html += `<div class="modal-section">`;
        if (s.title) html += `<div class="modal-section-title">${s.title}</div>`;
        if (s.text) html += `<div class="modal-text">${s.text}</div>`;
        if (s.example) html += `<div class="modal-example">üìå ${s.example}</div>`;
        html += `</div>`;
    });
    $('helpContent').innerHTML = html;
    $('helpModal').classList.add('active');
}

function showGlobalHelp() {
    $('helpContent').innerHTML = `
        <div class="modal-title">üí° How to Use This Calculator</div>
        <div class="modal-subtitle">Quick guide to comparing lease vs. rent options.</div>
        <div class="modal-section"><div class="modal-section-title">Step 1: Enter Your Numbers</div><div class="modal-text">Fill in asset price, loan terms, and market rent. Use ‚ìò buttons for field explanations.</div></div>
        <div class="modal-section"><div class="modal-section-title">Step 2: Set Economic Assumptions</div><div class="modal-text">Define investment returns, inflation, and risk comfort. These affect long-term comparisons.</div></div>
        <div class="modal-section"><div class="modal-section-title">Step 3: Read the Score</div><div class="modal-text"><strong>0-35:</strong> Rent is better | <strong>35-50:</strong> Neutral | <strong>50-85:</strong> Lease is better | <strong>85-100:</strong> Strong lease advantage</div></div>
    `;
    $('helpModal').classList.add('active');
}

function closeHelpModal(event) {
    if (event && event.target !== $('helpModal')) return;
    $('helpModal').classList.remove('active');
}

/* ================= INPUT SYNC ================= */
const syncInputs = [
    { id: 'leaseAmount', label: 'leaseAmountLabel', format: 'inr' },
    { id: 'loanAmount', label: 'loanAmountLabel', format: 'inr' },
    { id: 'loanRate', label: 'loanRateLabel', format: 'percent' },
    { id: 'maintenance', label: 'maintenanceLabel', format: 'inr' },
    { id: 'withholding', label: 'withholdingLabel', format: 'percent' },
    { id: 'refundDelay', label: 'refundDelayLabel', format: 'plain' },
    { id: 'marketRent', label: 'marketRentLabel', format: 'inr' },
    { id: 'rentDeposit', label: 'rentDepositLabel', format: 'inr' },
    { id: 'depositRefundDelay', label: 'depositRefundDelayLabel', format: 'plain' },
    { id: 'rentIncrement', label: 'rentIncrementLabel', format: 'percent' },
    { id: 'flexibilityPremium', label: 'flexibilityPremiumLabel', format: 'inr' },
    { id: 'leaseTenure', label: 'leaseTenureLabel', format: 'plain' },
    { id: 'loanTenure', label: 'loanTenureLabel', format: 'plain' },
    { id: 'oppRate', label: 'oppRateLabel', format: 'percent' },
    { id: 'riskPremium', label: 'riskPremiumLabel', format: 'percent' },
    { id: 'inflationRate', label: 'inflationRateLabel', format: 'percent' },
    { id: 'liquidityPremium', label: 'liquidityPremiumLabel', format: 'percent' },
    { id: 'returnVol', label: 'returnVolLabel', format: 'percent' }
];

syncInputs.forEach(({ id, label, format }) => {
    const input = $(id);
    const range = $(id + 'Range');
    const labelEl = label ? $(label) : null;

    const updateLabel = () => {
        if (!labelEl) return;
        const val = cleanNumber(input.value);
        if (format === 'inr') labelEl.innerText = formatINR(val);
        else if (format === 'percent') labelEl.innerText = formatPercent(val);
        else labelEl.innerText = val;
    };

    if (range) { range.addEventListener('input', () => { input.value = range.value; updateLabel(); calculate(); }); }
    input.addEventListener('input', () => { const clean = cleanNumber(input.value); if (range) range.value = clean; updateLabel(); calculate(); });
});

/* ================= EMI ================= */
function emi(P, r, n) {
    if (r === 0) return P / n;
    return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
}

/* ================= CHARTS ================= */
let tcoChart, monthlyCostChart, cumulativeImpactChart, sensitivityChart,
    costCompositionChart, rentProjectionChart, sensitivityHeatmapChart, amortizationChart;

let lastCalculationState = { monthlyLeaseCost: 0, monthlyRentCost: 0, LEASE_TENURE: 24 };

function initCharts(data) {
    const colors = getChartColors();

    // 1. TCO CHART
    if (!tcoChart) {
        tcoChart = new Chart($('tcoChart'), {
            type: 'bar',
            data: {
                labels: data.tco.labels,
                datasets: [{ label: 'Economic Cost', data: data.tco.values, backgroundColor: ['rgba(255,77,77,0.8)','rgba(155,89,182,0.8)','rgba(241,196,15,0.8)','rgba(77,179,255,0.8)','rgba(46,204,113,0.8)','rgba(0,212,255,0.8)'], borderRadius: 8, borderWidth: 0 }]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'right', color: colors.text, font: { weight: 'bold', size: 11 }, formatter: v => formatINR(v) },
                    tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatINR(ctx.parsed.x)}` } }
                },
                scales: {
                    x: { ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { color: colors.border } },
                    y: { ticks: { color: colors.muted }, grid: { display: false } }
                }
            },
            plugins: [ChartDataLabels]
        });
    } else {
        tcoChart.data.labels = data.tco.labels;
        tcoChart.data.datasets[0].data = data.tco.values;
        tcoChart.update();
    }

    // 2. MONTHLY COST CHART
    if (!monthlyCostChart) {
        monthlyCostChart = new Chart($('monthlyCostChart'), {
            type: 'bar',
            data: {
                labels: ['EMI', 'Maintenance', 'Risk-Adj. Lease', 'Market Rent', 'Advantage'],
                datasets: [
                    { label: 'Actual Lease Outflow', data: [data.monthly.emi, data.monthly.maintenance, null, null, null], backgroundColor: 'rgba(255,140,58,0.7)', borderRadius: 6, borderWidth: 0 },
                    { label: 'Economic Lease Cost', data: [null, null, data.monthly.riskRent, null, null], backgroundColor: 'rgba(155,89,182,0.7)', borderRadius: 6, borderWidth: 0 },
                    { label: 'Current Market Rent', data: [null, null, null, data.monthly.rent, null], backgroundColor: 'rgba(46,204,113,0.7)', borderRadius: 6, borderWidth: 0 },
                    { label: 'Monthly Savings', data: [null, null, null, null, data.monthly.advantage], backgroundColor: data.monthly.advantage >= 0 ? 'rgba(46,204,113,0.7)' : 'rgba(255,77,77,0.7)', borderRadius: 6, borderWidth: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: { anchor: 'top', align: 'center', color: colors.text, font: { weight: 'bold', size: 10 }, formatter: v => v ? formatINR(v) : '' },
                    tooltip: { callbacks: { label: ctx => ctx.parsed.y != null ? `${ctx.dataset.label}: ${formatINR(ctx.parsed.y)}` : '' } }
                },
                scales: {
                    y: { ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { color: colors.border } },
                    x: { ticks: { color: colors.muted }, grid: { display: false } }
                }
            },
            plugins: [ChartDataLabels]
        });
    } else {
        monthlyCostChart.data.datasets[0].data = [data.monthly.emi, data.monthly.maintenance, null, null, null];
        monthlyCostChart.data.datasets[1].data = [null, null, data.monthly.riskRent, null, null];
        monthlyCostChart.data.datasets[2].data = [null, null, null, data.monthly.rent, null];
        monthlyCostChart.data.datasets[3].data = [null, null, null, null, data.monthly.advantage];
        monthlyCostChart.data.datasets[3].backgroundColor = data.monthly.advantage >= 0 ? 'rgba(46,204,113,0.7)' : 'rgba(255,77,77,0.7)';
        monthlyCostChart.update();
    }

    // 3. CUMULATIVE IMPACT
    if (!cumulativeImpactChart) {
        cumulativeImpactChart = new Chart($('cumulativeImpactChart'), {
            type: 'line',
            data: {
                labels: data.cumulative.months,
                datasets: [
                    { label: 'Cumulative Lease Cost (Economic)', data: data.cumulative.leaseCosts, borderColor: 'rgba(255,77,77,0.9)', backgroundColor: 'rgba(255,77,77,0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 },
                    { label: 'Cumulative Market Rent', data: data.cumulative.buyCosts, borderColor: 'rgba(46,204,113,0.9)', backgroundColor: 'rgba(46,204,113,0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: { display: false },
                    tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatINR(ctx.parsed.y)}` } }
                },
                scales: {
                    y: { ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { color: colors.border } },
                    x: { ticks: { color: colors.muted }, grid: { display: false } }
                }
            }
        });
    } else {
        cumulativeImpactChart.data.labels = data.cumulative.months;
        cumulativeImpactChart.data.datasets[0].data = data.cumulative.leaseCosts;
        cumulativeImpactChart.data.datasets[1].data = data.cumulative.buyCosts;
        cumulativeImpactChart.update();
    }

    // 4. SENSITIVITY BUBBLE CHART
    // FIX 3: x-axis label changed from 'Scenario Index' to 'Rent Change (%)'
    if (!sensitivityChart) {
        sensitivityChart = new Chart($('sensitivityChart'), {
            type: 'bubble',
            data: {
                datasets: [
                    { label: 'Lease Advantage', data: data.sensitivity.leaseAdvantage, backgroundColor: 'rgba(255,77,77,0.6)', borderColor: 'rgba(255,77,77,0.9)', borderWidth: 1 },
                    { label: 'Rent Advantage', data: data.sensitivity.rentAdvantage, backgroundColor: 'rgba(46,204,113,0.6)', borderColor: 'rgba(46,204,113,0.9)', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'top' }, datalabels: { display: false } },
                scales: {
                    x: {
                        title: { display: true, text: 'Rent Change (%)', color: colors.muted }, // FIX 3
                        ticks: { callback: v => v + '%', color: colors.muted },
                        grid: { color: colors.border }
                    },
                    y: {
                        title: { display: true, text: 'Rent Growth Change (%)', color: colors.muted },
                        ticks: { callback: v => v + '%', color: colors.muted },
                        grid: { color: colors.border }
                    }
                }
            }
        });
    } else {
        sensitivityChart.data.datasets[0].data = data.sensitivity.leaseAdvantage;
        sensitivityChart.data.datasets[1].data = data.sensitivity.rentAdvantage;
        sensitivityChart.update();
    }

    // 5. COST COMPOSITION PIE
    if (!costCompositionChart) {
        costCompositionChart = new Chart($('costCompositionChart'), {
            type: 'doughnut',
            data: {
                labels: data.composition.labels,
                datasets: [{ data: data.composition.values, backgroundColor: ['rgba(255,77,77,0.9)','rgba(155,89,182,0.9)','rgba(241,196,15,0.9)','rgba(77,179,255,0.9)','rgba(46,204,113,0.9)','rgba(0,212,255,0.9)'], borderColor: colors.card, borderWidth: 3 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'bottom', labels: { color: colors.text, padding: 18, usePointStyle: true, font: { weight: '700', size: 12 } } },
                    datalabels: { color: colors.text, font: { weight: 'bold', size: 13 }, formatter: (v, ctx) => { const t = ctx.dataset.data.reduce((a,b)=>a+b,0); const p = ((v/t)*100).toFixed(0); return p > 5 ? p + '%' : ''; } },
                    tooltip: { callbacks: { label: ctx => { const t = ctx.dataset.data.reduce((a,b)=>a+b,0); return `${formatINR(ctx.parsed)} (${((ctx.parsed/t)*100).toFixed(1)}%)`; } } }
                }
            },
            plugins: [ChartDataLabels]
        });
    } else {
        costCompositionChart.data.labels = data.composition.labels;
        costCompositionChart.data.datasets[0].data = data.composition.values;
        costCompositionChart.update();
    }

    // 6. RENT PROJECTION
    const rp = data.rentProjection;
    const monthlyM1Save = rp.monthlyRent[0] - rp.leaseConstant[0];
    const finalMonthSave = rp.monthlyRent[rp.monthlyRent.length - 1] - rp.leaseConstant[rp.leaseConstant.length - 1];
    const totalCumulSave = rp.cumulativeSavings[rp.cumulativeSavings.length - 1];
    if ($('rentStatMonthly')) $('rentStatMonthly').textContent = formatINR(monthlyM1Save);
    if ($('rentStatCumulative')) $('rentStatCumulative').textContent = formatINR(totalCumulSave);
    if ($('rentStatFinal')) $('rentStatFinal').textContent = formatINR(finalMonthSave);
    if ($('rentCrossoverPill') && $('rentStatCrossover')) {
        if (rp.crossoverMonth) { $('rentCrossoverPill').style.display = ''; $('rentStatCrossover').textContent = 'M' + rp.crossoverMonth; }
        else { $('rentCrossoverPill').style.display = 'none'; }
    }

    if (!rentProjectionChart) {
        rentProjectionChart = new Chart($('rentProjectionChart'), {
            type: 'line',
            data: {
                labels: rp.months,
                datasets: [
                    { label: 'Market Rent (Escalating)', data: rp.monthlyRent, borderColor: 'rgba(46,204,113,1)', backgroundColor: 'rgba(46,204,113,0)', borderWidth: 2.5, fill: { target: 1, above: 'rgba(46,204,113,0.15)', below: 'rgba(255,77,77,0.12)' }, tension: 0.35, pointRadius: 0, pointHoverRadius: 6, yAxisID: 'y' },
                    { label: 'Lease Monthly Cost (Fixed)', data: rp.leaseConstant, borderColor: 'rgba(77,179,255,1)', backgroundColor: 'rgba(77,179,255,0)', borderWidth: 2.5, fill: false, tension: 0, pointRadius: 0, pointHoverRadius: 6, yAxisID: 'y' },
                    { label: 'Cumulative Net Savings', data: rp.cumulativeSavings, borderColor: 'rgba(155,89,182,0.9)', backgroundColor: 'rgba(155,89,182,0.08)', borderWidth: 2, fill: true, tension: 0.4, borderDash: [6,3], pointRadius: 0, pointHoverRadius: 5, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: colors.text, usePointStyle: true, padding: 16 } },
                    datalabels: { display: false },
                    tooltip: { callbacks: { label: (ctx) => { if (ctx.datasetIndex === 2) return `Cumulative Net Saving: ${formatINR(ctx.parsed.y)}`; const saving = rp.monthlyRent[ctx.dataIndex] - rp.leaseConstant[ctx.dataIndex]; if (ctx.datasetIndex === 0) return `Market Rent: ${formatINR(ctx.parsed.y)} (+${formatINR(saving)} vs lease)`; return `Lease Cost: ${formatINR(ctx.parsed.y)}`; } } }
                },
                scales: {
                    y: { title: { display: true, text: 'Monthly Cost', color: colors.muted }, ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { color: colors.border } },
                    y1: { title: { display: true, text: 'Cumulative Net Savings', color: colors.muted }, position: 'right', ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { drawOnChartArea: false } },
                    x: { ticks: { color: colors.muted, maxTicksLimit: 12 }, grid: { display: false } }
                }
            }
        });
    } else {
        rentProjectionChart.data.labels = rp.months;
        rentProjectionChart.data.datasets[0].data = rp.monthlyRent;
        rentProjectionChart.data.datasets[1].data = rp.leaseConstant;
        rentProjectionChart.data.datasets[2].data = rp.cumulativeSavings;
        rentProjectionChart.update();
    }

    // 7. SENSITIVITY TORNADO CHART
    if (!sensitivityHeatmapChart) {
        sensitivityHeatmapChart = new Chart($('sensitivityHeatmapChart'), {
            type: 'bar',
            data: {
                labels: data.sensitivityHeatmap.factors,
                datasets: [
                    { label: 'Less Savings', data: data.sensitivityHeatmap.negativeImpact, backgroundColor: 'rgba(255,77,77,0.75)', borderRadius: [6,0,0,6], borderWidth: 0 },
                    { label: 'More Savings', data: data.sensitivityHeatmap.positiveImpact, backgroundColor: 'rgba(46,204,113,0.75)', borderRadius: [0,6,6,0], borderWidth: 0 }
                ]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: colors.text, usePointStyle: true, padding: 16 } },
                    datalabels: { display: false },
                    tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatINR(Math.abs(ctx.raw))}` } }
                },
                scales: {
                    x: { stacked: true, type: 'linear', ticks: { callback: v => v !== 0 ? formatINR(Math.abs(v)) : '‚Çπ0', color: colors.muted, font: { size: 10 } }, grid: { color: colors.border } },
                    y: { stacked: true, ticks: { color: colors.muted, font: { size: 11, weight: '600' }, padding: 12 }, grid: { display: false } }
                }
            },
            plugins: [
                {
                    id: 'tornadoLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx, data, chartArea: { left, right } } = chart;
                        const MARGIN = 8;
                        ctx.font = 'bold 11px -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.textBaseline = 'middle';
                        data.datasets.forEach((dataset, datasetIndex) => {
                            dataset.data.forEach((value, index) => {
                                if (!value) return;
                                const meta = chart.getDatasetMeta(datasetIndex);
                                const bar = meta.data[index];
                                if (!bar) return;
                                const label = formatINR(Math.abs(value));
                                if (datasetIndex === 0) { ctx.textAlign = 'left'; ctx.fillStyle = 'rgba(255,77,77,0.95)'; ctx.fillText(label, left + MARGIN, bar.y); }
                                else { ctx.textAlign = 'right'; ctx.fillStyle = 'rgba(46,204,113,0.95)'; ctx.fillText(label, right - MARGIN, bar.y); }
                            });
                        });
                    }
                },
                {
                    id: 'zeroLine',
                    afterDatasetsDraw(chart) {
                        const { ctx, chartArea: { left, top, height } } = chart;
                        const x = left + chart.scales.x.getPixelForValue(0);
                        ctx.strokeStyle = colors.primary; ctx.lineWidth = 2; ctx.setLineDash([]);
                        ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, top + height); ctx.stroke();
                    }
                }
            ]
        });
        lastSensitivityData = data.sensitivityHeatmap;
    } else {
        sensitivityHeatmapChart.data.labels = data.sensitivityHeatmap.factors;
        sensitivityHeatmapChart.data.datasets[0].data = data.sensitivityHeatmap.negativeImpact;
        sensitivityHeatmapChart.data.datasets[1].data = data.sensitivityHeatmap.positiveImpact;
        lastSensitivityData = data.sensitivityHeatmap;
        sensitivityHeatmapChart.update();
    }

    // 8. AMORTIZATION
    if (!amortizationChart) {
        amortizationChart = new Chart($('amortizationChart'), {
            type: 'bar',
            data: {
                labels: data.amortization.months,
                datasets: [
                    { label: 'Principal', type: 'bar', data: data.amortization.principal, backgroundColor: 'rgba(46,204,113,0.8)', borderWidth: 0, stack: 'Stack 0' },
                    { label: 'Interest', type: 'bar', data: data.amortization.interest, backgroundColor: 'rgba(255,77,77,0.8)', borderWidth: 0, stack: 'Stack 0' },
                    { label: 'Remaining Balance', type: 'line', data: data.amortization.balance, borderColor: 'rgba(77,179,255,1)', backgroundColor: 'transparent', borderWidth: 3, fill: false, tension: 0.4, pointRadius: 0, pointHoverRadius: 6, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: colors.text } },
                    datalabels: { display: false },
                    tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatINR(ctx.parsed.y ?? ctx.raw)}` } }
                },
                scales: {
                    y: { stacked: true, title: { display: true, text: 'Monthly EMI Breakdown' }, ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { color: colors.border } },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'Remaining Loan Balance' }, ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { drawOnChartArea: false } },
                    x: { ticks: { color: colors.muted }, grid: { display: false } }
                }
            }
        });
    } else {
        amortizationChart.data.labels = data.amortization.months;
        amortizationChart.data.datasets[0].data = data.amortization.principal;
        amortizationChart.data.datasets[1].data = data.amortization.interest;
        amortizationChart.data.datasets[2].data = data.amortization.balance;
        amortizationChart.update();
    }
}

/* ================= SUMMARY PANEL ================= */
function updateSummary() {
    const asset = num('leaseAmount'), loan = num('loanAmount'), rent = num('marketRent'), tenure = num('leaseTenure') / 12;
    $('summaryAsset').innerText = formatINR(asset);
    $('summaryLoan').innerText = formatINR(loan);
    $('summaryRent').innerText = formatINR(rent);
    $('summaryTerm').innerText = Math.round(tenure) + ' yrs';
}

/* ================= VERDICT BANNER ================= */
function updateVerdictBanner(monthlySavings, termSavings, score, tenure, confidence) {
    const banner = $('verdictBanner'), headline = $('verdictHeadline'), body = $('verdictBody');
    const mSavEl = $('verdictMonthlySaving'), tSavEl = $('verdictTermSaving');
    const leaseBetter = monthlySavings > 0;
    const neutral = Math.abs(monthlySavings) < 500;
    const cls = neutral ? 'neutral' : (leaseBetter ? 'lease-wins' : 'rent-wins');
    const valCls = neutral ? 'neutral' : (leaseBetter ? 'positive' : 'negative');
    banner.className = 'verdict-banner ' + cls;
    const tenureYrs = Math.round(tenure / 12 * 10) / 10;
    const confRound = Math.round(confidence);
    const absMonthly = formatINR(Math.abs(monthlySavings));
    const absTerm = formatINR(Math.abs(termSavings));
    if (neutral) {
        headline.textContent = '‚öñÔ∏è It\'s a close call ‚Äî consider lifestyle & flexibility';
        body.innerHTML = `Monthly costs are nearly equal (<strong>${absMonthly}/mo difference</strong>).`;
    } else if (leaseBetter) {
        headline.textContent = score >= 80 ? 'üèÜ Lease is the clear winner ‚Äî strongly recommended' : '‚úÖ Leasing has the economic edge';
        body.innerHTML = `Based on your inputs, leasing saves you <strong>${absMonthly}/month</strong> ‚Äî that's <strong>${absTerm}</strong> over ${tenureYrs} years. Confidence: <strong>${confRound}%</strong>.`;
    } else {
        headline.textContent = score <= 20 ? 'üî¥ Renting is significantly more economical' : '‚ö†Ô∏è Renting has the economic edge';
        body.innerHTML = `Renting saves you <strong>${absMonthly}/month</strong> vs leasing ‚Äî a difference of <strong>${absTerm}</strong> over ${tenureYrs} years.`;
    }
    mSavEl.className = 'verdict-stat-value ' + valCls;
    mSavEl.textContent = (leaseBetter ? '+' : '-') + absMonthly + '/mo';
    tSavEl.className = 'verdict-stat-value ' + valCls;
    tSavEl.textContent = (leaseBetter ? '+' : '-') + absTerm;
}

/* ================= MAIN CALCULATION ================= */
function calculate() {
    try {
        updateSummary();

        const LEASE_AMOUNT = num('leaseAmount');
        const LOAN_AMOUNT = num('loanAmount');
        const OWN_FUNDS = Math.max(0, LEASE_AMOUNT - LOAN_AMOUNT);
        const LOAN_RATE_ANNUAL = num('loanRate');
        const LOAN_TENURE = num('loanTenure');
        const LEASE_TENURE = num('leaseTenure');
        const WITHHOLDING = num('withholding') / 100;
        const REFUND_DELAY = num('refundDelay');
        const MAINTENANCE = num('maintenance');
        const MARKET_RENT = num('marketRent');
        const RENT_DEPOSIT = num('rentDeposit');
        const DEPOSIT_REFUND_DELAY = num('depositRefundDelay');
        const OPP_RATE_ANNUAL = num('oppRate');
        const RISK_PREMIUM = num('riskPremium') / 100;
        const RENT_INCREMENT = num('rentIncrement') / 100;
        const FLEXIBILITY_PREMIUM = num('flexibilityPremium');
        const INFLATION_ANNUAL = num('inflationRate');
        const LIQUIDITY_ANNUAL = num('liquidityPremium');
        const VOLATILITY = num('returnVol') / 100;

        if (LEASE_AMOUNT <= 0 || LEASE_TENURE <= 0 || LOAN_TENURE <= 0 || MARKET_RENT <= 0) return;

        const LOAN_RATE_MONTHLY = (LOAN_RATE_ANNUAL / 100) / 12;
        const OPP_RATE_NOMINAL = (OPP_RATE_ANNUAL / 100) / 12;
        const INFLATION_MONTHLY = (INFLATION_ANNUAL / 100) / 12;
        const LIQUIDITY_MONTHLY = (LIQUIDITY_ANNUAL / 100) / 12;

        const REAL_OPP_RATE = ((1 + OPP_RATE_NOMINAL) / (1 + INFLATION_MONTHLY)) - 1;

        // =====================================================================
        // FIX 1: Volatility penalty converted to monthly scale
        // Was: 0.5 * VOLATILITY * VOLATILITY  (annual applied to monthly rate ‚Äî 23√ó too large)
        // Now: (0.5 * VOLATILITY * VOLATILITY) / 12  (correct monthly certainty-equivalent penalty)
        // =====================================================================
        const VOLATILITY_PENALTY = (0.5 * VOLATILITY * VOLATILITY) / 12;
        const CE_REAL_OPP_RATE = Math.max(0, REAL_OPP_RATE - VOLATILITY_PENALTY);

        const LOCKED_FUNDS_RATE = CE_REAL_OPP_RATE + LIQUIDITY_MONTHLY;
        const WITHHOLDING_CLAMPED = Math.min(1, Math.max(0, WITHHOLDING));
        const effectiveLoanMonths = Math.min(LOAN_TENURE, LEASE_TENURE);

        const EMI = emi(LOAN_AMOUNT, LOAN_RATE_MONTHLY, effectiveLoanMonths);
        const totalInterestPaid = (EMI * effectiveLoanMonths) - LOAN_AMOUNT;

        const withholdingLoss = LEASE_AMOUNT * WITHHOLDING_CLAMPED;
        const depositRefundable = LEASE_AMOUNT * (1 - WITHHOLDING_CLAMPED);
        const ownFundsOppCost = OWN_FUNDS * (Math.pow(1 + LOCKED_FUNDS_RATE, LEASE_TENURE) - 1);
        const delayCost = REFUND_DELAY > 0 ? depositRefundable * (Math.pow(1 + LOCKED_FUNDS_RATE, REFUND_DELAY) - 1) : 0;
        const totalMaintenanceCost = MAINTENANCE * LEASE_TENURE;
        const totalLeaseCostWithoutRisk = totalInterestPaid + withholdingLoss + ownFundsOppCost + delayCost + totalMaintenanceCost;
        const riskCost = LEASE_AMOUNT * RISK_PREMIUM * (LEASE_TENURE / 12);
        const riskAdjustedLeaseCost = totalLeaseCostWithoutRisk + riskCost;
        const monthlyLeaseCost = riskAdjustedLeaseCost / LEASE_TENURE;

        let totalRentPaidOverLeaseTerm = 0;
        for (let m = 1; m <= LEASE_TENURE; m++) {
            const yearIndex = Math.floor((m - 1) / 12);
            totalRentPaidOverLeaseTerm += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
        }

        const rentDepositOppCost = RENT_DEPOSIT * (Math.pow(1 + CE_REAL_OPP_RATE, LEASE_TENURE) - 1);
        const rentDepositDelayOppCost = DEPOSIT_REFUND_DELAY > 0 ? RENT_DEPOSIT * (Math.pow(1 + CE_REAL_OPP_RATE, DEPOSIT_REFUND_DELAY) - 1) : 0;
        const totalFlexibilityCost = Math.min(FLEXIBILITY_PREMIUM * LEASE_TENURE, totalRentPaidOverLeaseTerm + rentDepositOppCost + rentDepositDelayOppCost);
        const totalRentCostOverLeaseTerm = Math.max(1, totalRentPaidOverLeaseTerm + rentDepositOppCost + rentDepositDelayOppCost - totalFlexibilityCost);
        const monthlyRentCost = totalRentCostOverLeaseTerm / LEASE_TENURE;

        const savingFraction = (totalRentCostOverLeaseTerm - riskAdjustedLeaseCost) / Math.max(totalRentCostOverLeaseTerm, riskAdjustedLeaseCost);
        const score = Math.max(0, Math.min(100, 50 + 50 * savingFraction));
        const monthlySavings = monthlyRentCost - monthlyLeaseCost;
        const yearlySavings = monthlySavings * 12;
        const termSavings = monthlySavings * LEASE_TENURE;
        const confidence = Math.max(0, Math.min(100, Math.abs(savingFraction) * 100));

        let color = '#f1c40f', interpretation = 'üìä Balanced decision - Consider other factors';
        if (score >= 85) { color = '#1abc9c'; interpretation = 'üéØ Excellent Leasing Advantage - Highly favorable to lease'; }
        else if (score >= 65) { color = '#2ecc71'; interpretation = '‚úÖ Strong Leasing Advantage - Leasing is recommended'; }
        else if (score >= 50) { color = '#f1c40f'; interpretation = 'üìä Marginal Leasing Advantage - Consider flexibility & other factors'; }
        else if (score >= 35) { color = '#ff9f43'; interpretation = '‚ö†Ô∏è Slight Renting Advantage - Renting is marginally better'; }
        else { color = '#ff4d4d'; interpretation = '‚ùå Strong Renting Advantage - Renting is significantly more economical'; }

        const gaugeDegrees = score * 3.6;
        $('gauge').style.background = `conic-gradient(${color} ${gaugeDegrees}deg, #1a2a38 ${gaugeDegrees}deg)`;
        $('dial').style.color = color;
        $('dial').innerText = Math.round(score);
        $('interpretation').innerText = interpretation;

        const animateCounter = (el, start, end, dur = 800) => {
            const t0 = Date.now();
            const tick = () => {
                const p = Math.min((Date.now() - t0) / dur, 1);
                const ease = p < 0.5 ? 2*p*p : -1+(4-2*p)*p;
                const val = start + (end - start) * ease;
                el.textContent = el.textContent.includes('%') ? Math.round(val) + '%' : formatINR(val);
                if (p < 1) requestAnimationFrame(tick);
            };
            tick();
        };

        animateCounter($('mEMI'), cleanNumber($('mEMI').textContent), EMI);
        animateCounter($('mMaintenance'), cleanNumber($('mMaintenance').textContent), MAINTENANCE);
        animateCounter($('mSave'), cleanNumber($('mSave').textContent), monthlySavings);
        animateCounter($('ySave'), cleanNumber($('ySave').textContent), yearlySavings);
        animateCounter($('tSave'), cleanNumber($('tSave').textContent), termSavings);
        animateCounter($('mEffective'), cleanNumber($('mEffective').textContent), monthlyLeaseCost);
        $('confidence').textContent = Math.round(confidence) + '%';

        updateVerdictBanner(monthlySavings, termSavings, score, LEASE_TENURE, confidence);

        // --- CHART DATA ---
        const tcoData = {
            labels: ['Interest Paid', 'Withholding Loss', 'Own Funds Opp Cost', 'Refund Delay Cost', 'Total Maintenance', 'Net Lease Risk Cost'],
            values: [Math.max(0,totalInterestPaid), Math.max(0,withholdingLoss), Math.max(0,ownFundsOppCost), Math.max(0,delayCost), Math.max(0,totalMaintenanceCost), Math.max(0,riskCost)]
        };

        const monthlyData = { emi: EMI, maintenance: MAINTENANCE, rent: MARKET_RENT, riskRent: monthlyLeaseCost, advantage: monthlySavings };

        let cumulativeLeaseCosts = [], cumulativeRentCosts = [], cumulativeMonths = [], cL = 0, cR = 0;
        for (let m = 1; m <= LEASE_TENURE; m++) {
            cL += monthlyLeaseCost;
            cR += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Math.floor((m-1)/12));
            cumulativeLeaseCosts.push(cL); cumulativeRentCosts.push(cR);
            cumulativeMonths.push('Y' + (Math.floor((m-1)/12)+1) + 'M' + ((m%12)||12));
        }

        const sensitivityLeaseAdvantage = [], sensitivityRentAdvantage = [];
        for (let rentChange = -15; rentChange <= 15; rentChange += 3) {
            const adjRent = MARKET_RENT * (1 + rentChange / 100);
            const adjustedSavings = adjRent - monthlyLeaseCost;
            if (adjustedSavings > 0) sensitivityLeaseAdvantage.push({ x: rentChange, y: rentChange, r: Math.min(30, Math.sqrt(Math.abs(adjustedSavings)/100)) });
            else sensitivityRentAdvantage.push({ x: rentChange, y: rentChange, r: Math.min(30, Math.sqrt(Math.abs(adjustedSavings)/100)) });
        }

        const compositionData = {
            labels: ['Interest', 'Withholding', 'Own Funds Opp', 'Refund Delay', 'Maintenance', 'Net Lease Risk'],
            values: [Math.max(1,totalInterestPaid), Math.max(1,withholdingLoss), Math.max(1,ownFundsOppCost), Math.max(1,delayCost), Math.max(1,totalMaintenanceCost), Math.max(1,riskCost)]
        };

        let rentMonthlyRent = [], leaseConstantRent = [], cumulativeSavings = [], rentMonths = [], rentT = 0, leaseT = 0, crossoverMonth = null;
        for (let m = 1; m <= LEASE_TENURE; m++) {
            const mr = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Math.floor((m-1)/12));
            rentT += mr; leaseT += monthlyLeaseCost;
            rentMonthlyRent.push(mr); leaseConstantRent.push(monthlyLeaseCost);
            cumulativeSavings.push(rentT - leaseT);
            rentMonths.push('M' + m);
            if (crossoverMonth === null && mr > monthlyLeaseCost) crossoverMonth = m;
        }

        // Sensitivity tornado base
        const baseMonthlySavings = monthlyRentCost - monthlyLeaseCost;
        const impactFactors = [];

        // Interest Rate (higher rate = higher lease cost = less savings)
        {
            const upRate = LOAN_RATE_MONTHLY * 1.1, downRate = LOAN_RATE_MONTHLY * 0.9;
            const upEMI = emi(LOAN_AMOUNT, upRate, effectiveLoanMonths);
            const downEMI = emi(LOAN_AMOUNT, downRate, effectiveLoanMonths);
            const upSavings = monthlyRentCost - (monthlyLeaseCost + (upEMI - EMI));
            const downSavings = monthlyRentCost - (monthlyLeaseCost - (EMI - downEMI));
            impactFactors.push({ name: 'Interest Rate', negative: baseMonthlySavings - upSavings, positive: downSavings - baseMonthlySavings });
        }

        // FIX 2a: Market Rent ‚Äî higher rent HELPS leasing; adverse = -10%, favorable = +10%
        {
            const upRent = MARKET_RENT * 1.1, downRent = MARKET_RENT * 0.9;
            const upSavings = upRent - monthlyLeaseCost;
            const downSavings = downRent - monthlyLeaseCost;
            impactFactors.push({
                name: 'Market Rent',
                negative: baseMonthlySavings - downSavings,  // FIX: lower rent = less savings
                positive: upSavings - baseMonthlySavings      // FIX: higher rent = more savings
            });
        }

        // Maintenance (higher = higher lease cost = less savings)
        {
            const upMaint = MAINTENANCE * 1.1, downMaint = MAINTENANCE * 0.9;
            const upSavings = monthlyRentCost - (monthlyLeaseCost + (upMaint - MAINTENANCE));
            const downSavings = monthlyRentCost - (monthlyLeaseCost - (MAINTENANCE - downMaint));
            impactFactors.push({ name: 'Maintenance', negative: baseMonthlySavings - upSavings, positive: downSavings - baseMonthlySavings });
        }

        // Loan Amount (higher = higher EMI = less savings)
        {
            const upLoan = LOAN_AMOUNT * 1.1, downLoan = LOAN_AMOUNT * 0.9;
            const upEMI = emi(upLoan, LOAN_RATE_MONTHLY, effectiveLoanMonths);
            const downEMI = emi(downLoan, LOAN_RATE_MONTHLY, effectiveLoanMonths);
            const upSavings = monthlyRentCost - (monthlyLeaseCost + (upEMI - EMI));
            const downSavings = monthlyRentCost - (monthlyLeaseCost - (EMI - downEMI));
            impactFactors.push({ name: 'Loan Amount', negative: baseMonthlySavings - upSavings, positive: downSavings - baseMonthlySavings });
        }

        // FIX 2b: Rent Growth ‚Äî higher growth HELPS leasing; adverse = -10%, favorable = +10%
        {
            const upGrowth = RENT_INCREMENT * 1.1, downGrowth = RENT_INCREMENT * 0.9;
            let upRentTotal = 0, downRentTotal = 0, baseRentTotal = 0;
            for (let m = 1; m <= LEASE_TENURE; m++) {
                const yr = Math.floor((m-1)/12);
                upRentTotal += MARKET_RENT * Math.pow(1 + upGrowth, yr);
                downRentTotal += MARKET_RENT * Math.pow(1 + downGrowth, yr);
                baseRentTotal += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yr);
            }
            const upMonthlyRent = upRentTotal / LEASE_TENURE;
            const downMonthlyRent = downRentTotal / LEASE_TENURE;
            const baseMonthlyRent = baseRentTotal / LEASE_TENURE;
            const upSavings = (monthlyRentCost * upMonthlyRent / baseMonthlyRent) - monthlyLeaseCost;
            const downSavings = (monthlyRentCost * downMonthlyRent / baseMonthlyRent) - monthlyLeaseCost;
            impactFactors.push({
                name: 'Rent Growth',
                negative: baseMonthlySavings - downSavings,  // FIX: lower growth = less savings
                positive: upSavings - baseMonthlySavings      // FIX: higher growth = more savings
            });
        }

        impactFactors.sort((a, b) => (Math.abs(b.negative) + Math.abs(b.positive)) - (Math.abs(a.negative) + Math.abs(a.positive)));

        const sensitivityHeatmapData = {
            factors: impactFactors.map(f => f.name),
            negativeImpact: impactFactors.map(f => -f.negative),
            positiveImpact: impactFactors.map(f => f.positive)
        };

        // Amortization
        const amortMonths = [], amortPrincipal = [], amortInterest = [], amortBalance = [];
        let remainingBalance = LOAN_AMOUNT;
        for (let m = 1; m <= effectiveLoanMonths && m <= LEASE_TENURE; m++) {
            const interestPayment = remainingBalance * LOAN_RATE_MONTHLY;
            const principalPayment = EMI - interestPayment;
            remainingBalance = Math.max(0, remainingBalance - principalPayment);
            amortMonths.push('M' + m); amortPrincipal.push(principalPayment);
            amortInterest.push(interestPayment); amortBalance.push(remainingBalance);
        }

        initCharts({
            tco: tcoData, monthly: monthlyData,
            cumulative: { months: cumulativeMonths, leaseCosts: cumulativeLeaseCosts, buyCosts: cumulativeRentCosts },
            sensitivity: { leaseAdvantage: sensitivityLeaseAdvantage, rentAdvantage: sensitivityRentAdvantage },
            composition: compositionData,
            rentProjection: { months: rentMonths, monthlyRent: rentMonthlyRent, leaseConstant: leaseConstantRent, cumulativeSavings, crossoverMonth },
            sensitivityHeatmap: sensitivityHeatmapData,
            amortization: { months: amortMonths, principal: amortPrincipal, interest: amortInterest, balance: amortBalance }
        });

        updateComparisonTable(EMI, MAINTENANCE, monthlyLeaseCost, monthlyRentCost, monthlySavings, termSavings, LEASE_TENURE);
        lastCalculationState = { monthlyLeaseCost, monthlyRentCost, LEASE_TENURE };

    } catch (error) { console.error('Calculation error:', error); }
}

function updateComparisonTable(emi, maintenance, economicCost, rentCost, advantage, termAdvantage, leaseTenure) {
    const tbody = $('comparisonBody');
    const leaseBetter = advantage > 0;
    const actualLeaseOutflow = emi + maintenance;
    tbody.innerHTML = `
        <tr><td><strong>Monthly EMI</strong></td><td>${formatINR(emi)}</td><td>-</td><td>-</td></tr>
        <tr><td><strong>Monthly Maintenance</strong></td><td>${formatINR(maintenance)}</td><td>-</td><td>-</td></tr>
        <tr><td><strong>Actual Monthly Lease Outflow</strong></td><td>${formatINR(actualLeaseOutflow)}</td><td>-</td><td>-</td></tr>
        <tr><td><strong>Monthly Rent</strong></td><td>-</td><td>${formatINR(rentCost)}</td><td>-</td></tr>
        <tr><td><strong>Monthly Cost (Economic)</strong></td>
            <td class="${leaseBetter ? 'metric-positive' : 'metric-negative'}">${formatINR(economicCost)}</td>
            <td class="${leaseBetter ? 'metric-negative' : 'metric-positive'}">${formatINR(rentCost)}</td>
            <td class="${advantage >= 0 ? 'metric-positive' : 'metric-negative'}">${formatINR(Math.abs(advantage))}</td></tr>
        <tr><td><strong>Annual Impact</strong></td>
            <td class="${leaseBetter ? 'metric-positive' : 'metric-negative'}">${formatINR(economicCost * 12)}</td>
            <td class="${leaseBetter ? 'metric-negative' : 'metric-positive'}">${formatINR(rentCost * 12)}</td>
            <td class="${advantage >= 0 ? 'metric-positive' : 'metric-negative'}">${formatINR(Math.abs(advantage) * 12)}</td></tr>
        <tr><td><strong>Lease Term Total</strong></td>
            <td class="${leaseBetter ? 'metric-positive' : 'metric-negative'}">${formatINR(economicCost * leaseTenure)}</td>
            <td class="${leaseBetter ? 'metric-negative' : 'metric-positive'}">${formatINR(rentCost * leaseTenure)}</td>
            <td class="${advantage >= 0 ? 'metric-positive' : 'metric-negative'}">${formatINR(Math.abs(termAdvantage))}</td></tr>
    `;
}

/* ================= SENSITIVITY MODE SWITCHING ================= */
let currentSensitivityMode = 'overview', lastSensitivityData = null;

function switchSensitivityMode(factor) {
    if (!factor) {
        $('sensitivityOverviewMode').style.display = 'block';
        $('sensitivityInteractiveMode').style.display = 'none';
        $('sensitivityTitle').innerText = 'What Changes Your Monthly Savings Most';
        document.querySelectorAll('.sensitivity-chip').forEach(c => c.classList.remove('active'));
        if (lastSensitivityData && sensitivityHeatmapChart) {
            sensitivityHeatmapChart.destroy(); sensitivityHeatmapChart = null;
            // Recreate from lastSensitivityData
            const colors = getChartColors();
            sensitivityHeatmapChart = new Chart($('sensitivityHeatmapChart'), {
                type: 'bar',
                data: { labels: lastSensitivityData.factors, datasets: [
                    { label: 'Less Savings', data: lastSensitivityData.negativeImpact, backgroundColor: 'rgba(255,77,77,0.75)', borderRadius: [6,0,0,6], borderWidth: 0 },
                    { label: 'More Savings', data: lastSensitivityData.positiveImpact, backgroundColor: 'rgba(46,204,113,0.75)', borderRadius: [0,6,6,0], borderWidth: 0 }
                ]},
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: colors.text, usePointStyle: true, padding: 16 } }, datalabels: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatINR(Math.abs(ctx.raw))}` } } },
                    scales: { x: { stacked: true, type: 'linear', ticks: { callback: v => v !== 0 ? formatINR(Math.abs(v)) : '‚Çπ0', color: colors.muted, font: { size: 10 } }, grid: { color: colors.border } }, y: { stacked: true, ticks: { color: colors.muted, font: { size: 11, weight: '600' }, padding: 12 }, grid: { display: false } } }
                }
            });
        }
    } else {
        $('sensitivityOverviewMode').style.display = 'none';
        $('sensitivityInteractiveMode').style.display = 'block';
        $('interactiveTitle').innerText = `Monthly Savings vs ${factor}`;
        document.querySelectorAll('.sensitivity-chip').forEach(c => c.classList.toggle('active', c.innerText === factor));
        const interactiveData = generateInteractiveSensitivity(factor);
        updateInteractiveSensitivityChart(interactiveData);
    }
}

function generateInteractiveSensitivity(factor) {
    const points = [], range = 50, step = 5;
    const baseMonthlyLeaseCost = lastCalculationState.monthlyLeaseCost;
    const baseMonthlyRentCost = lastCalculationState.monthlyRentCost;
    const LEASE_TENURE = lastCalculationState.LEASE_TENURE;

    // Shared rent-side components that are independent of market rent and growth rate
    const CE_REAL_OPP_RATE = (() => {
        const OPP_RATE_NOMINAL = (num('oppRate') / 100) / 12;
        const INFLATION_MONTHLY = (num('inflationRate') / 100) / 12;
        const VOLATILITY = num('returnVol') / 100;
        const REAL_OPP_RATE = ((1 + OPP_RATE_NOMINAL) / (1 + INFLATION_MONTHLY)) - 1;
        const VOLATILITY_PENALTY = (0.5 * VOLATILITY * VOLATILITY) / 12;
        return Math.max(0, REAL_OPP_RATE - VOLATILITY_PENALTY);
    })();
    const RENT_DEPOSIT = num('rentDeposit');
    const DEPOSIT_REFUND_DELAY = num('depositRefundDelay');
    const FLEXIBILITY_PREMIUM = num('flexibilityPremium');
    const rentDepositOppCost = RENT_DEPOSIT * (Math.pow(1 + CE_REAL_OPP_RATE, LEASE_TENURE) - 1);
    const rentDepositDelayOppCost = DEPOSIT_REFUND_DELAY > 0
        ? RENT_DEPOSIT * (Math.pow(1 + CE_REAL_OPP_RATE, DEPOSIT_REFUND_DELAY) - 1) : 0;
    const fixedRentSideCost = rentDepositOppCost + rentDepositDelayOppCost;

    if (factor === 'Market Rent') {
        // FIX: recompute totalRent with new rent value; deposit costs stay fixed
        const baseRent = num('marketRent');
        const baseGrowth = num('rentIncrement') / 100;
        for (let change = -range; change <= range; change += step) {
            const newRent = baseRent * (1 + change / 100);
            let newRentTotal = 0;
            for (let m = 1; m <= LEASE_TENURE; m++) {
                newRentTotal += newRent * Math.pow(1 + baseGrowth, Math.floor((m-1)/12));
            }
            const totalFlex = Math.min(FLEXIBILITY_PREMIUM * LEASE_TENURE, newRentTotal + fixedRentSideCost);
            const newMonthlyRentCost = Math.max(1, newRentTotal + fixedRentSideCost - totalFlex) / LEASE_TENURE;
            points.push({ x: change, y: newMonthlyRentCost - baseMonthlyLeaseCost });
        }
    } else if (factor === 'Interest Rate') {
        // Correct as-is: only EMI changes, own funds unaffected by rate
        const baseRate = (num('loanRate') / 100) / 12;
        const loanAmount = num('loanAmount'), loanTenure = num('loanTenure');
        for (let change = -range; change <= range; change += step) {
            const newRate = baseRate * (1 + change / 100);
            const newEMI = emi(loanAmount, newRate, loanTenure);
            const baseEMI = emi(loanAmount, baseRate, loanTenure);
            const savings = baseMonthlyRentCost - (baseMonthlyLeaseCost + (newEMI - baseEMI));
            points.push({ x: change, y: savings });
        }
    } else if (factor === 'Loan Amount') {
        // FIX: recompute ownFundsOppCost delta alongside EMI delta
        const baseRate = (num('loanRate') / 100) / 12;
        const baseLoan = num('loanAmount');
        const loanTenure = num('loanTenure');
        const LEASE_AMOUNT = num('leaseAmount');
        const LOCKED_FUNDS_RATE = CE_REAL_OPP_RATE + (num('liquidityPremium') / 100) / 12;
        const baseOwnFunds = Math.max(0, LEASE_AMOUNT - baseLoan);
        const baseOwnFundsOppCost = baseOwnFunds * (Math.pow(1 + LOCKED_FUNDS_RATE, LEASE_TENURE) - 1);
        const baseEMI = emi(baseLoan, baseRate, loanTenure);
        for (let change = -range; change <= range; change += step) {
            const newLoan = Math.max(0, Math.min(baseLoan * (1 + change / 100), LEASE_AMOUNT));
            const newEMI = emi(newLoan, baseRate, loanTenure);
            const newOwnFunds = Math.max(0, LEASE_AMOUNT - newLoan);
            const newOwnFundsOppCost = newOwnFunds * (Math.pow(1 + LOCKED_FUNDS_RATE, LEASE_TENURE) - 1);
            const ownFundsOppDelta = (newOwnFundsOppCost - baseOwnFundsOppCost) / LEASE_TENURE;
            const emiDelta = newEMI - baseEMI;
            const savings = baseMonthlyRentCost - (baseMonthlyLeaseCost + emiDelta + ownFundsOppDelta);
            points.push({ x: change, y: savings });
        }
    } else if (factor === 'Maintenance') {
        // Correct as-is: linear, no interaction with other components
        const baseMaint = num('maintenance');
        for (let change = -range; change <= range; change += step) {
            const savings = baseMonthlyRentCost - (baseMonthlyLeaseCost + (baseMaint * change / 100));
            points.push({ x: change, y: savings });
        }
    } else if (factor === 'Rent Growth') {
        // FIX: recompute totalRent with new growth; deposit costs stay fixed
        const baseRent = num('marketRent');
        const baseGrowth = num('rentIncrement') / 100;
        for (let change = -range; change <= range; change += step) {
            const newGrowth = Math.max(0, baseGrowth * (1 + change / 100));
            let newRentTotal = 0;
            for (let m = 1; m <= LEASE_TENURE; m++) {
                newRentTotal += baseRent * Math.pow(1 + newGrowth, Math.floor((m-1)/12));
            }
            const totalFlex = Math.min(FLEXIBILITY_PREMIUM * LEASE_TENURE, newRentTotal + fixedRentSideCost);
            const newMonthlyRentCost = Math.max(1, newRentTotal + fixedRentSideCost - totalFlex) / LEASE_TENURE;
            points.push({ x: change, y: newMonthlyRentCost - baseMonthlyLeaseCost });
        }
    }
    return { factor, points };
}

function updateInteractiveSensitivityChart(data) {
    const colors = getChartColors();
    if (sensitivityHeatmapChart) { sensitivityHeatmapChart.destroy(); sensitivityHeatmapChart = null; }
    sensitivityHeatmapChart = new Chart($('sensitivityHeatmapChart'), {
        type: 'line',
        data: {
            labels: data.points.map(p => p.x + '%'),
            datasets: [{ label: 'Monthly Savings (‚Çπ)', data: data.points.map(p => p.y), borderColor: 'rgba(77,179,255,0.9)', backgroundColor: 'rgba(77,179,255,0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: 'rgba(77,179,255,1)', pointHoverRadius: 7 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: true, position: 'top' }, datalabels: { display: false }, tooltip: { callbacks: { label: ctx => `Monthly Savings: ${formatINR(ctx.parsed.y)}` } } },
            scales: {
                x: { title: { display: true, text: `Change in ${data.factor}`, color: colors.muted }, ticks: { color: colors.muted }, grid: { color: colors.border } },
                y: { title: { display: true, text: 'Monthly Savings (‚Çπ)', color: colors.muted }, ticks: { callback: v => formatINR(v), color: colors.muted }, grid: { color: colors.border } }
            }
        }
    });
}

/* ================= INIT ================= */
loadFromURL();
calculate();
</script>
</body>
</html>
