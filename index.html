<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease vs Rent - Advanced BI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        /* ============================= */
        /* ===== ELITE FINTECH BI UI ==== */
        /* ============================= */

        :root {
            --bg: #060d15;
            --card: #0e1a27;
            --text: #eaf2f9;
            --accent: #4db3ff;
            --muted: #94a8bd;
            --green: #2ecc71;
            --amber: #f1c40f;
            --red: #ff4d4d;
            --purple: #9b59b6;
            --border: #1a2a38;
            --cyan: #00d4ff;
            --orange: #ff8c3a;
        }

        body.light {
            --bg: #f4f7fb;
            --card: #ffffff;
            --text: #0b1622;
            --accent: #1f4e79;
            --muted: #5c6c7a;
            --border: #e0e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: 0.35s ease;
            scroll-behavior: smooth;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            gap: 28px;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toggle {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            border: none;
            transition: 0.3s;
        }

        .toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(77, 179, 255, 0.3);
        }

        /* ===== CARDS ===== */
        .card, .chartCard {
            background: linear-gradient(135deg, var(--card), rgba(30, 40, 50, 0.5));
            padding: 28px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.show, .chartCard.show {
            opacity: 1;
            transform: translateY(0);
        }

        .card:hover, .chartCard:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 55px rgba(0, 0, 0, 0.45);
            border-color: var(--accent);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 24px;
        }

        /* ===== GRID LAYOUT ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 12px;
            }
        }

        /* ===== FORM FIELDS ===== */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        input[type="text"],
        input[type="number"] {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1.5px solid var(--border);
            background: rgba(10, 24, 38, 0.5);
            color: var(--text);
            font-weight: 700;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: 0.25s;
        }

        body.light input[type="text"],
        body.light input[type="number"] {
            background: rgba(240, 245, 250, 0.7);
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card);
            box-shadow: 0 0 12px rgba(77, 179, 255, 0.2);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(77, 179, 255, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(77, 179, 255, 0.4);
        }

        .micro {
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            min-height: 14px;
            transition: 0.25s;
        }

        /* ===== DECISION GAUGE ===== */
        .gauge-section {
            text-align: center;
            padding: 20px 0;
        }

        .gaugeWrap {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .gauge {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 40px rgba(77, 179, 255, 0.25);
            position: relative;
            background: conic-gradient(#4db3ff 0deg, #9b59b6 360deg);
        }

        .gauge::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(20px);
            opacity: 0.3;
            z-index: -1;
        }

        .gaugeInner {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 48px;
            font-weight: 900;
            box-shadow: inset 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .gauge-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 8px;
        }

        .gauge-interpretation {
            font-size: 15px;
            margin-top: 20px;
            color: var(--muted);
            line-height: 1.7;
            min-height: 50px;
            font-weight: 600;
        }

        /* ===== METRICS ===== */
        .metricsBox {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .metric-card {
            background: rgba(77, 179, 255, 0.1);
            padding: 18px;
            border-radius: 12px;
            border: 1px solid rgba(77, 179, 255, 0.2);
            transition: 0.3s;
            cursor: pointer;
        }

        .metric-card:hover {
            background: rgba(77, 179, 255, 0.15);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 11px;
            color: var(--muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        /* ===== CHARTS ===== */
        .chartCard {
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 420px;
            margin-top: 16px;
            animation: fadeInChart 0.8s ease-out;
        }

        @keyframes fadeInChart {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        canvas {
            max-height: 100% !important;
        }

        .chart-description {
            font-size: 12px;
            color: var(--muted);
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            line-height: 1.7;
        }

        /* ===== CHARTS GRID ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 24px;
        }

        .chart-full {
            grid-column: 1 / -1;
        }

        @media (max-width: 1400px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== COMPARATIVE TABLE ===== */
        .comparison-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .comparison-table th {
            background: rgba(77, 179, 255, 0.1);
            padding: 14px;
            text-align: left;
            font-weight: 700;
            border-bottom: 2px solid var(--border);
            font-size: 12px;
            text-transform: uppercase;
            color: var(--accent);
        }

        .comparison-table td {
            padding: 14px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .comparison-table tr:hover {
            background: rgba(77, 179, 255, 0.05);
        }

        .metric-positive {
            color: var(--green);
            font-weight: 700;
        }

        .metric-negative {
            color: var(--red);
            font-weight: 700;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .card, .chartCard {
                padding: 16px;
            }

            .card-title {
                font-size: 16px;
            }

            .chart-container {
                height: 300px;
            }

            .gauge {
                width: 180px;
                height: 180px;
            }

            .gaugeInner {
                width: 145px;
                height: 145px;
                font-size: 36px;
            }

            .header {
                flex-direction: column;
                gap: 12px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .show {
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(77, 179, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(77, 179, 255, 0.5);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <div class="logo">üí∞ Aladdin Finance BI</div>
        <button class="toggle" onclick="toggleTheme()">
            <span id="theme-icon">üåô</span> <span id="theme-text">Dark</span>
        </button>
    </div>

    <div class="container">

        <!-- INPUT PANEL -->
        <div class="card">
            <div class="card-title"><span class="card-icon">‚öôÔ∏è</span>Financial Parameters</div>
            <div class="grid">

                <div class="field">
                    <label>Lease Amount (‚Çπ)</label>
                    <input id="leaseAmount" type="text" value="2000000">
                    <input type="range" id="leaseAmountRange" min="100000" max="5000000" step="50000" value="2000000">
                </div>

                <div class="field">
                    <label>Loan Amount (‚Çπ)</label>
                    <input id="loanAmount" type="text" value="1500000">
                    <input type="range" id="loanAmountRange" min="0" max="3000000" step="50000" value="1500000">
                </div>

                <div class="field">
                    <label>Loan Interest Rate (%)</label>
                    <input id="loanRate" type="text" value="8.5">
                    <input type="range" id="loanRateRange" min="1" max="20" step="0.1" value="8.5">
                </div>

                <div class="field">
                    <label>Opportunity Cost (%)</label>
                    <input id="oppRate" type="text" value="12">
                    <input type="range" id="oppRateRange" min="1" max="20" step="0.1" value="12">
                </div>

                <div class="field">
                    <label>Risk Premium (%)</label>
                    <input id="riskPremium" type="text" value="3">
                    <input type="range" id="riskPremiumRange" min="0" max="20" step="0.1" value="3">
                </div>

                <div class="field">
                    <label>Market Rent (‚Çπ)</label>
                    <input id="marketRent" type="text" value="45000">
                    <input type="range" id="marketRentRange" min="5000" max="100000" step="1000" value="45000">
                </div>

                <div class="field">
                    <label>Monthly Maintenance (‚Çπ)</label>
                    <input id="maintenance" type="text" value="5000">
                    <input type="range" id="maintenanceRange" min="0" max="20000" step="500" value="5000">
                </div>

                <div class="field">
                    <label>Rent Increment (%)</label>
                    <input id="rentIncrement" type="text" value="5">
                    <input type="range" id="rentIncrementRange" min="0" max="10" step="0.5" value="5">
                </div>

                <div class="field">
                    <label>Loan Tenure (Months)</label>
                    <input id="loanTenure" type="text" value="240">
                </div>

                <div class="field">
                    <label>Lease Tenure (Months)</label>
                    <input id="leaseTenure" type="text" value="240">
                </div>

                <div class="field">
                    <label>Withholding (%)</label>
                    <input id="withholding" type="text" value="0">
                </div>

                <div class="field">
                    <label>Refund Delay (Months)</label>
                    <input id="refundDelay" type="text" value="0">
                </div>

            </div>
        </div>

        <!-- DECISION GAUGE & KPIs -->
        <div class="card">
            <div class="card-title"><span class="card-icon">üìä</span>Decision Intelligence Score</div>
            <div class="gauge-section">
                <div class="gaugeWrap">
                    <div id="gauge" class="gauge">
                        <div class="gaugeInner">
                            <span id="dial">0</span>
                            <div class="gauge-label">Score</div>
                        </div>
                    </div>
                </div>
                <div class="gauge-interpretation" id="interpretation">Analyzing parameters...</div>
            </div>

            <div class="metricsBox">
                <div class="metric-card">
                    <div class="metric-label">Monthly Advantage</div>
                    <div id="mSave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Annual Advantage</div>
                    <div id="ySave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Term Advantage</div>
                    <div id="tSave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Decision Confidence</div>
                    <div id="confidence" class="metric-value">0%</div>
                </div>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="charts-grid">

            <!-- 1. Total Cost of Ownership Waterfall -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üíæ</span>Total Cost Drivers</div>
                <div class="chart-container">
                    <canvas id="tcoChart"></canvas>
                </div>
                <div class="chart-description">
                    üìå Breakdown of all cost components impacting the buy vs. lease decision. Identify which factors drive the most impact.
                </div>
            </div>

            <!-- 2. Monthly Cost Comparison Waterfall -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üí∞</span>Monthly Cost Structure</div>
                <div class="chart-container">
                    <canvas id="monthlyCostChart"></canvas>
                </div>
                <div class="chart-description">
                    üìä Direct comparison of monthly outflows: EMI+Maintenance vs. Risk-Adjusted Lease Cost. Shows your monthly decision outcome.
                </div>
            </div>

            <!-- 3. 10-Year Cumulative Impact (Full Width) -->
            <div class="chartCard chart-full">
                <div class="card-title"><span class="card-icon">üìà</span>Cumulative Financial Impact Over Time</div>
                <div class="chart-container">
                    <canvas id="cumulativeImpactChart"></canvas>
                </div>
                <div class="chart-description">
                    üéØ The most critical chart: Shows total accumulated costs/savings over the lease tenure. The spread between lines is your actual financial advantage.
                </div>
            </div>

            <!-- 4. Sensitivity Analysis Heatmap -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üî•</span>Decision Robustness Matrix</div>
                <div class="chart-container">
                    <canvas id="sensitivityChart"></canvas>
                </div>
                <div class="chart-description">
                    ‚ö†Ô∏è Tests decision reliability: How does the outcome change with interest rate and rent growth variations? Red = buy advantage, Green = lease advantage.
                </div>
            </div>

            <!-- 5. Cost Composition Pie -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">ü•ß</span>Economic Cost Distribution</div>
                <div class="chart-container">
                    <canvas id="costCompositionChart"></canvas>
                </div>
                <div class="chart-description">
                    üí° What's eating your budget? See which cost categories dominate: Interest, Opportunity costs, Withholding losses, etc.
                </div>
            </div>

            <!-- 6. Rent Escalation Forecast -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üìä</span>Rent Growth Trajectory</div>
                <div class="chart-container">
                    <canvas id="rentProjectionChart"></canvas>
                </div>
                <div class="chart-description">
                    üöÄ How will your lease costs evolve? Shows projected rent escalation and cumulative rent burden over time.
                </div>
            </div>

        </div>

        <!-- COMPARISON TABLE -->
        <div class="card">
            <div class="card-title"><span class="card-icon">üìã</span>Buy vs Lease Financial Summary</div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Buy (EMI + Maintenance)</th>
                        <th>Lease (Market Rent)</th>
                        <th>Advantage</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

    </div>

    <script>

        /* ================= THEME ================= */
        function toggleTheme() {
            const isDark = !document.body.classList.contains('light');
            document.body.classList.toggle('light');
            
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeUI();
            
            // Redraw charts with new colors
            setTimeout(() => {
                if (tcoChart) tcoChart.update();
                if (monthlyCostChart) monthlyCostChart.update();
                if (cumulativeImpactChart) cumulativeImpactChart.update();
                if (sensitivityChart) sensitivityChart.update();
                if (costCompositionChart) costCompositionChart.update();
                if (rentProjectionChart) rentProjectionChart.update();
            }, 100);
        }

        function updateThemeUI() {
            const isDark = !document.body.classList.contains('light');
            document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-text').textContent = isDark ? 'Dark' : 'Light';
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
            updateThemeUI();
        }

        /* ================= SCROLL REVEAL ================= */
        const observer = new IntersectionObserver(entries => {
            entries.forEach(e => {
                if (e.isIntersecting) {
                    e.target.classList.add('show');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.card, .chartCard').forEach(el => observer.observe(el));

        /* ================= HELPERS ================= */
        const $ = id => document.getElementById(id);

        function cleanNumber(v) {
            return parseFloat((v || '').replace(/[,%\s,‚Çπ]/g, '')) || 0;
        }

        function num(id) {
            const val = cleanNumber($(id).value);
            return isNaN(val) ? 0 : val;
        }

        function formatINR(n) {
            n = Math.max(0, Number(n) || 0);
            return '‚Çπ' + Math.round(n).toLocaleString('en-IN');
        }

        function formatPercent(n) {
            n = Number(n) || 0;
            return Number(n).toLocaleString('en-IN', { maximumFractionDigits: 2 }) + '%';
        }

        function getChartColors() {
            const isDark = !document.body.classList.contains('light');
            return {
                text: isDark ? '#eaf2f9' : '#0b1622',
                muted: isDark ? '#94a8bd' : '#5c6c7a',
                border: isDark ? '#1a2a38' : '#e0e8f0',
                primary: '#4db3ff',
                secondary: '#9b59b6',
                success: '#2ecc71',
                danger: '#ff4d4d',
                warning: '#f1c40f',
                cyan: '#00d4ff',
                orange: '#ff8c3a'
            };
        }

        /* ================= INPUT SYNC ================= */
        ['leaseAmount', 'loanAmount', 'loanRate', 'oppRate', 'riskPremium', 'marketRent', 'maintenance', 'rentIncrement']
            .forEach(id => {
                const input = $(id);
                const range = $(id + 'Range');
                if (!range) return;

                range.addEventListener('input', () => {
                    input.value = range.value;
                    calculate();
                });

                input.addEventListener('input', () => {
                    const clean = cleanNumber(input.value);
                    range.value = clean;
                    calculate();
                });
            });

        /* ================= EMI CALCULATOR ================= */
        function emi(P, r, n) {
            if (r === 0) return P / n;
            return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
        }

        /* ================= CHARTS ================= */
        let tcoChart, monthlyCostChart, cumulativeImpactChart, sensitivityChart, costCompositionChart, rentProjectionChart;

        function initCharts(data) {
            const colors = getChartColors();

            // 1. TCO CHART (Horizontal Bar - Waterfall Style)
            if (!tcoChart) {
                tcoChart = new Chart($('tcoChart'), {
                    type: 'bar',
                    data: {
                        labels: data.tco.labels,
                        datasets: [{
                            label: 'Cost Component',
                            data: data.tco.values,
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(241, 196, 15, 0.8)',
                                'rgba(77, 179, 255, 0.8)',
                                'rgba(255, 140, 58, 0.8)'
                            ],
                            borderRadius: 8,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'right',
                                color: colors.text,
                                font: { weight: 'bold', size: 11 },
                                formatter: v => formatINR(v)
                            }
                        },
                        scales: {
                            x: {
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            y: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                tcoChart.data.labels = data.tco.labels;
                tcoChart.data.datasets[0].data = data.tco.values;
                tcoChart.update();
            }

            // 2. MONTHLY COST CHART (Grouped Bar)
            if (!monthlyCostChart) {
                monthlyCostChart = new Chart($('monthlyCostChart'), {
                    type: 'bar',
                    data: {
                        labels: ['EMI', 'Maintenance', 'Total Buy Cost', 'Market Rent', 'Risk Adj. Rent', 'Monthly Advantage'],
                        datasets: [
                            {
                                label: 'Buy Scenario',
                                data: [data.monthly.emi, data.monthly.maintenance, data.monthly.buyCost, null, null, null],
                                backgroundColor: 'rgba(255, 77, 77, 0.7)',
                                borderRadius: 6,
                                borderWidth: 0
                            },
                            {
                                label: 'Lease Scenario',
                                data: [null, null, null, data.monthly.rent, data.monthly.riskRent, data.monthly.advantage],
                                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                borderRadius: 6,
                                borderWidth: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: {
                                anchor: 'top',
                                align: 'center',
                                color: colors.text,
                                font: { weight: 'bold', size: 10 },
                                formatter: v => v ? formatINR(v) : ''
                            }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            x: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                monthlyCostChart.data.datasets[0].data = [data.monthly.emi, data.monthly.maintenance, data.monthly.buyCost, null, null, null];
                monthlyCostChart.data.datasets[1].data = [null, null, null, data.monthly.rent, data.monthly.riskRent, data.monthly.advantage];
                monthlyCostChart.update();
            }

            // 3. CUMULATIVE IMPACT (Line Chart - Most Important)
            if (!cumulativeImpactChart) {
                cumulativeImpactChart = new Chart($('cumulativeImpactChart'), {
                    type: 'line',
                    data: {
                        labels: data.cumulative.months,
                        datasets: [
                            {
                                label: 'Buy: Cumulative Cost',
                                data: data.cumulative.buyCosts,
                                borderColor: 'rgba(255, 77, 77, 0.9)',
                                backgroundColor: 'rgba(255, 77, 77, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Lease: Cumulative Cost',
                                data: data.cumulative.leaseCosts,
                                borderColor: 'rgba(46, 204, 113, 0.9)',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            x: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                cumulativeImpactChart.data.labels = data.cumulative.months;
                cumulativeImpactChart.data.datasets[0].data = data.cumulative.buyCosts;
                cumulativeImpactChart.data.datasets[1].data = data.cumulative.leaseCosts;
                cumulativeImpactChart.update();
            }

            // 4. SENSITIVITY CHART (Bubble/Scatter for Decision Robustness)
            if (!sensitivityChart) {
                sensitivityChart = new Chart($('sensitivityChart'), {
                    type: 'bubble',
                    data: {
                        datasets: [
                            {
                                label: 'Buy Advantage',
                                data: data.sensitivity.buyAdvantage,
                                backgroundColor: 'rgba(255, 77, 77, 0.6)',
                                borderColor: 'rgba(255, 77, 77, 0.9)',
                                borderWidth: 1
                            },
                            {
                                label: 'Lease Advantage',
                                data: data.sensitivity.leaseAdvantage,
                                backgroundColor: 'rgba(46, 204, 113, 0.6)',
                                borderColor: 'rgba(46, 204, 113, 0.9)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Interest Rate Change (%)', color: colors.muted },
                                ticks: { callback: v => v + '%', color: colors.muted },
                                grid: { color: colors.border }
                            },
                            y: {
                                title: { display: true, text: 'Rent Growth Change (%)', color: colors.muted },
                                ticks: { callback: v => v + '%', color: colors.muted },
                                grid: { color: colors.border }
                            }
                        }
                    }
                });
            } else {
                sensitivityChart.data.datasets[0].data = data.sensitivity.buyAdvantage;
                sensitivityChart.data.datasets[1].data = data.sensitivity.leaseAdvantage;
                sensitivityChart.update();
            }

            // 5. COST COMPOSITION PIE
            if (!costCompositionChart) {
                costCompositionChart = new Chart($('costCompositionChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.composition.labels,
                        datasets: [{
                            data: data.composition.values,
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(241, 196, 15, 0.8)',
                                'rgba(255, 140, 58, 0.8)'
                            ],
                            borderColor: colors.card,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom' },
                            datalabels: {
                                color: colors.text,
                                font: { weight: 'bold', size: 11 },
                                formatter: (v, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((v / total) * 100).toFixed(1);
                                    return percent + '%';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                costCompositionChart.data.labels = data.composition.labels;
                costCompositionChart.data.datasets[0].data = data.composition.values;
                costCompositionChart.update();
            }

            // 6. RENT PROJECTION
            if (!rentProjectionChart) {
                rentProjectionChart = new Chart($('rentProjectionChart'), {
                    type: 'line',
                    data: {
                        labels: data.rentProjection.months,
                        datasets: [
                            {
                                label: 'Monthly Rent',
                                data: data.rentProjection.monthlyRent,
                                borderColor: 'rgba(77, 179, 255, 0.9)',
                                backgroundColor: 'rgba(77, 179, 255, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Cumulative Rent Burden',
                                data: data.rentProjection.cumulativeRent,
                                borderColor: 'rgba(255, 140, 58, 0.9)',
                                backgroundColor: 'rgba(255, 140, 58, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Monthly Rent' },
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            y1: {
                                title: { display: true, text: 'Cumulative Rent' },
                                position: 'right',
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { drawOnChartArea: false }
                            },
                            x: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                rentProjectionChart.data.labels = data.rentProjection.months;
                rentProjectionChart.data.datasets[0].data = data.rentProjection.monthlyRent;
                rentProjectionChart.data.datasets[1].data = data.rentProjection.cumulativeRent;
                rentProjectionChart.update();
            }
        }

        /* ================= MAIN CALCULATION ================= */
        function calculate() {
            try {
                const LEASE_AMOUNT = num('leaseAmount');
                const LOAN_AMOUNT = num('loanAmount');
                const OWN_FUNDS = Math.max(0, LEASE_AMOUNT - LOAN_AMOUNT);

                const LOAN_INTEREST_RATE = (num('loanRate') / 100) / 12;
                const LOAN_TENURE = num('loanTenure');
                const LEASE_TENURE = num('leaseTenure');

                const WITHHOLDING = num('withholding') / 100;
                const REFUND_DELAY = num('refundDelay');

                const MAINTENANCE = num('maintenance');
                const MARKET_RENT = num('marketRent');

                const OPP_RATE = (num('oppRate') / 100) / 12;
                const RISK_PREMIUM = num('riskPremium') / 100;
                const RENT_INCREMENT = num('rentIncrement') / 100;

                // Validation
                if (LEASE_TENURE <= 0 || LOAN_TENURE <= 0 || MARKET_RENT <= 0) {
                    console.warn('Invalid parameters');
                    return;
                }

                // EMI & Interest
                const EMI = emi(LOAN_AMOUNT, LOAN_INTEREST_RATE, LOAN_TENURE);
                const totalInterest = EMI * LOAN_TENURE - LOAN_AMOUNT;
                const monthlyBuyCost = EMI + MAINTENANCE;

                // Withholding & Refund
                const refund = LEASE_AMOUNT * (1 - WITHHOLDING);
                const withholdingLoss = LEASE_AMOUNT * WITHHOLDING;

                // Opportunity Costs
                const ownOpp = OWN_FUNDS * (Math.pow(1 + OPP_RATE, LEASE_TENURE) - 1);

                let emiOpp = 0;
                for (let m = 1; m <= LEASE_TENURE; m++) {
                    const yearIndex = Math.floor((m - 1) / 12);
                    const adjustedRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    const extra = monthlyBuyCost - adjustedRent;
                    if (extra > 0) {
                        emiOpp += extra * (Math.pow(1 + OPP_RATE, LEASE_TENURE - m + 1) - 1);
                    }
                }

                const delayCost = refund * OPP_RATE * REFUND_DELAY;
                const capitalLoss = totalInterest + withholdingLoss;
                const totalEconomic = capitalLoss + ownOpp + emiOpp + delayCost;

                const riskRent = (totalEconomic / LEASE_TENURE) * (1 + RISK_PREMIUM);
                const monthlySavings = MARKET_RENT - riskRent;
                const yearlySavings = monthlySavings * 12;
                const termSavings = monthlySavings * LEASE_TENURE;

                // Score & Confidence
                let score = MARKET_RENT > 0 ? (monthlySavings / MARKET_RENT) * 100 : 0;
                score = Math.max(0, Math.min(100, score));

                const confidence = Math.abs(monthlySavings) / MARKET_RENT * 100;

                let color = '#f1c40f';
                let interpretation = 'üìä Balanced decision - Consider other factors';

                if (score < 5) {
                    color = '#ff4d4d';
                    interpretation = '‚ùå Strong Buying Advantage - Buying is significantly more economical';
                } else if (score < 25) {
                    color = '#ff9f43';
                    interpretation = '‚ö†Ô∏è Slight Buying Advantage - Buying is marginally better';
                } else if (score < 50) {
                    color = '#f1c40f';
                    interpretation = 'üìä Marginal Leasing Advantage - Consider flexibility & other factors';
                } else if (score < 75) {
                    color = '#2ecc71';
                    interpretation = '‚úÖ Strong Leasing Advantage - Leasing is recommended';
                } else {
                    color = '#1abc9c';
                    interpretation = 'üéØ Excellent Leasing Advantage - Highly favorable to lease';
                }

                // Update Gauge
                const gaugeDegrees = score * 3.6;
                $('gauge').style.background = `conic-gradient(${color} ${gaugeDegrees}deg, #1a2a38 ${gaugeDegrees}deg)`;
                $('dial').style.color = color;
                $('dial').innerText = Math.round(score);
                $('interpretation').innerText = interpretation;

                // Update Metrics
                $('mSave').innerText = formatINR(monthlySavings);
                $('ySave').innerText = formatINR(yearlySavings);
                $('tSave').innerText = formatINR(termSavings);
                $('confidence').innerText = Math.round(Math.min(100, confidence)) + '%';

                // ========== PREPARE CHART DATA ==========

                // 1. TCO Data
                const tcoData = {
                    labels: ['Interest Paid', 'Withholding Loss', 'Own Funds Opp Cost', 'EMI Opp Cost', 'Refund Delay Cost'],
                    values: [
                        Math.max(0, totalInterest),
                        Math.max(0, withholdingLoss),
                        Math.max(0, ownOpp),
                        Math.max(0, emiOpp),
                        Math.max(0, delayCost)
                    ]
                };

                // 2. Monthly Cost Data
                const monthlyData = {
                    emi: EMI,
                    maintenance: MAINTENANCE,
                    buyCost: monthlyBuyCost,
                    rent: MARKET_RENT,
                    riskRent: riskRent,
                    advantage: monthlySavings
                };

                // 3. Cumulative Data
                let cumulativeBuyCosts = [];
                let cumulativeLeaseCosts = [];
                let cumulativeMonths = [];
                let cumulativeBuyTotal = 0;
                let cumulativeLeaseTotal = 0;

                for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
                    cumulativeBuyTotal += monthlyBuyCost;
                    const yearIndex = Math.floor((m - 1) / 12);
                    const monthlyLeaseRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    cumulativeLeaseTotal += monthlyLeaseRent;
                    
                    cumulativeBuyCosts.push(cumulativeBuyTotal);
                    cumulativeLeaseCosts.push(cumulativeLeaseTotal);
                    cumulativeMonths.push('Y' + (Math.floor((m - 1) / 12) + 1) + 'M' + ((m % 12) || 12));
                }

                const cumulativeData = {
                    months: cumulativeMonths,
                    buyCosts: cumulativeBuyCosts,
                    leaseCosts: cumulativeLeaseCosts
                };

                // 4. Sensitivity Data
                const sensitivityBuyAdvantage = [];
                const sensitivityLeaseAdvantage = [];

                for (let rateChange = -15; rateChange <= 15; rateChange += 3) {
                    for (let rentChange = -15; rentChange <= 15; rentChange += 3) {
                        const adjRate = LOAN_INTEREST_RATE * (1 + rateChange / 100);
                        const adjRent = MARKET_RENT * (1 + rentChange / 100);
                        const adjEMI = emi(LOAN_AMOUNT, adjRate, LOAN_TENURE);
                        const adjMonthly = adjEMI + MAINTENANCE;
                        
                        const netDifference = Math.abs(adjMonthly - adjRent);
                        
                        if (adjMonthly < adjRent) {
                            sensitivityBuyAdvantage.push({
                                x: rateChange,
                                y: rentChange,
                                r: Math.sqrt(netDifference / 100)
                            });
                        } else {
                            sensitivityLeaseAdvantage.push({
                                x: rateChange,
                                y: rentChange,
                                r: Math.sqrt(netDifference / 100)
                            });
                        }
                    }
                }

                const sensitivityData = {
                    buyAdvantage: sensitivityBuyAdvantage,
                    leaseAdvantage: sensitivityLeaseAdvantage
                };

                // 5. Cost Composition
                const compositionData = {
                    labels: ['Total Interest', 'Opp Costs', 'Withholding', 'Delay Cost'],
                    values: [
                        Math.max(1, totalInterest),
                        Math.max(1, ownOpp + emiOpp),
                        Math.max(1, withholdingLoss),
                        Math.max(1, delayCost)
                    ]
                };

                // 6. Rent Projection
                const rentMonthlyRent = [];
                const rentCumulativeRent = [];
                const rentMonths = [];
                let rentTotal = 0;

                for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
                    const yearIndex = Math.floor((m - 1) / 12);
                    const monthlyRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    rentTotal += monthlyRent;
                    
                    rentMonthlyRent.push(monthlyRent);
                    rentCumulativeRent.push(rentTotal);
                    rentMonths.push('M' + m);
                }

                const rentProjectionData = {
                    months: rentMonths,
                    monthlyRent: rentMonthlyRent,
                    cumulativeRent: rentCumulativeRent
                };

                // Initialize all charts
                initCharts({
                    tco: tcoData,
                    monthly: monthlyData,
                    cumulative: cumulativeData,
                    sensitivity: sensitivityData,
                    composition: compositionData,
                    rentProjection: rentProjectionData
                });

                // Update Comparison Table
                updateComparisonTable(monthlyBuyCost, MARKET_RENT, riskRent, monthlySavings, termSavings);

            } catch (error) {
                console.error('Calculation error:', error);
            }
        }

        function updateComparisonTable(buyCost, rent, riskRent, advantage, termAdvantage) {
            const tbody = $('comparisonBody');
            tbody.innerHTML = `
                <tr>
                    <td><strong>Monthly Cost</strong></td>
                    <td class="metric-negative">${formatINR(buyCost)}</td>
                    <td class="metric-positive">${formatINR(rent)}</td>
                    <td class="metric-negative">${formatINR(buyCost - rent)}</td>
                </tr>
                <tr>
                    <td><strong>Risk-Adjusted Cost</strong></td>
                    <td class="metric-negative">${formatINR(buyCost)}</td>
                    <td class="metric-positive">${formatINR(riskRent)}</td>
                    <td>${formatINR(advantage)}</td>
                </tr>
                <tr>
                    <td><strong>Annual Impact</strong></td>
                    <td class="metric-negative">${formatINR(buyCost * 12)}</td>
                    <td class="metric-positive">${formatINR(rent * 12)}</td>
                    <td>${formatINR(advantage * 12)}</td>
                </tr>
                <tr>
                    <td><strong>Lease Term Total</strong></td>
                    <td class="metric-negative">${formatINR(buyCost * 240)}</td>
                    <td class="metric-positive">${formatINR(rent * 240)}</td>
                    <td>${formatINR(termAdvantage)}</td>
                </tr>
            `;
        }

        /* ================= EVENT LISTENERS ================= */
        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('input', () => {
                const timer = setTimeout(calculate, 300);
                el.addEventListener('input', () => {
                    clearTimeout(timer);
                }, { once: true });
            });
        });

        // Initial Calculation
        window.addEventListener('load', calculate);
        calculate();

    </script>
</body>

</html>