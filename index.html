<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease vs Rent Calculator - Aladdin Finance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        :root {
            --bg: #060d15;
            --card: #0e1a27;
            --text: #eaf2f9;
            --accent: #4db3ff;
            --muted: #94a8bd;
            --green: #2ecc71;
            --amber: #f1c40f;
            --red: #ff4d4d;
        }

        body.light {
            --bg: #f4f7fb;
            --card: #ffffff;
            --text: #0b1622;
            --accent: #1f4e79;
            --muted: #5c6c7a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: 0.35s;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(77, 179, 255, 0.2);
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            color: var(--accent);
        }

        .toggle {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            border: none;
            font-weight: 700;
        }

        .toggle:hover {
            opacity: 0.9;
        }

        .card {
            background: var(--card);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(77, 179, 255, 0.1);
            margin-bottom: 24px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        input[type="text"],
        input[type="number"] {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid rgba(77, 179, 255, 0.2);
            background: rgba(10, 24, 38, 0.5);
            color: var(--text);
            font-weight: 700;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card);
        }

        input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: rgba(77, 179, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        .micro {
            font-size: 10px;
            color: var(--accent);
            font-weight: 700;
            min-height: 12px;
        }

        .gauge-section {
            text-align: center;
            padding: 20px 0;
        }

        .gauge {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(77, 179, 255, 0.3);
        }

        .gauge-inner {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 38px;
            font-weight: 900;
            box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .gauge-label {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            margin-top: 6px;
        }

        .interpretation {
            font-size: 13px;
            color: var(--muted);
            margin-top: 16px;
            line-height: 1.5;
            min-height: 30px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-top: 20px;
        }

        .metric {
            background: rgba(77, 179, 255, 0.1);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(77, 179, 255, 0.15);
        }

        .metric-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 900;
            color: var(--accent);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(77, 179, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        canvas {
            max-height: 100% !important;
        }

        .description {
            font-size: 11px;
            color: var(--muted);
            margin-top: 12px;
            line-height: 1.4;
            padding-top: 10px;
            border-top: 1px solid rgba(77, 179, 255, 0.1);
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">üí∞ Aladdin Finance</div>
            <button class="toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span> Theme
            </button>
        </div>

        <!-- INPUT PANEL -->
        <div class="card">
            <div class="card-title">‚öôÔ∏è Financial Parameters</div>
            <div class="grid">
                <div class="field">
                    <label>Lease Amount (‚Çπ)</label>
                    <input id="leaseAmount" type="text" value="2000000" onchange="calculate()">
                    <input type="range" id="leaseAmountRange" min="100000" max="5000000" step="50000" value="2000000" onchange="syncInput('leaseAmount')">
                </div>

                <div class="field">
                    <label>Loan Amount (‚Çπ)</label>
                    <input id="loanAmount" type="text" value="1500000" onchange="calculate()">
                    <input type="range" id="loanAmountRange" min="0" max="3000000" step="50000" value="1500000" onchange="syncInput('loanAmount')">
                </div>

                <div class="field">
                    <label>Loan Interest Rate (%)</label>
                    <input id="loanRate" type="text" value="8.5" onchange="calculate()">
                    <div id="emiLabel" class="micro"></div>
                    <input type="range" id="loanRateRange" min="1" max="20" step="0.1" value="8.5" onchange="syncInput('loanRate')">
                </div>

                <div class="field">
                    <label>Opportunity Cost (%)</label>
                    <input id="oppRate" type="text" value="12" onchange="calculate()">
                    <div id="oppLabel" class="micro"></div>
                    <input type="range" id="oppRateRange" min="1" max="20" step="0.1" value="12" onchange="syncInput('oppRate')">
                </div>

                <div class="field">
                    <label>Risk Premium (%)</label>
                    <input id="riskPremium" type="text" value="3" onchange="calculate()">
                    <div id="riskLabel" class="micro"></div>
                    <input type="range" id="riskPremiumRange" min="0" max="20" step="0.1" value="3" onchange="syncInput('riskPremium')">
                </div>

                <div class="field">
                    <label>Market Rent (‚Çπ)</label>
                    <input id="marketRent" type="text" value="45000" onchange="calculate()">
                    <input type="range" id="marketRentRange" min="5000" max="100000" step="1000" value="45000" onchange="syncInput('marketRent')">
                </div>

                <div class="field">
                    <label>Monthly Maintenance (‚Çπ)</label>
                    <input id="maintenance" type="text" value="5000" onchange="calculate()">
                    <input type="range" id="maintenanceRange" min="0" max="20000" step="500" value="5000" onchange="syncInput('maintenance')">
                </div>

                <div class="field">
                    <label>Rent Increment (%)</label>
                    <input id="rentIncrement" type="text" value="5" onchange="calculate()">
                </div>

                <div class="field">
                    <label>Loan Tenure (Months)</label>
                    <input id="loanTenure" type="text" value="240" onchange="calculate()">
                </div>

                <div class="field">
                    <label>Lease Tenure (Months)</label>
                    <input id="leaseTenure" type="text" value="240" onchange="calculate()">
                </div>

                <div class="field">
                    <label>Withholding (%)</label>
                    <input id="withholding" type="text" value="0" onchange="calculate()">
                </div>

                <div class="field">
                    <label>Refund Delay (Months)</label>
                    <input id="refundDelay" type="text" value="0" onchange="calculate()">
                </div>
            </div>
        </div>

        <!-- GAUGE PANEL -->
        <div class="card">
            <div class="card-title">üìä Decision Score</div>
            <div class="gauge-section">
                <div class="gauge">
                    <div class="gauge-inner">
                        <span id="dial">0</span>
                        <div class="gauge-label">Score</div>
                    </div>
                </div>
                <div class="interpretation" id="interpretation">Analyzing...</div>
            </div>

            <div class="metrics">
                <div class="metric">
                    <div class="metric-label">Monthly Savings</div>
                    <div id="mSave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Yearly Savings</div>
                    <div id="ySave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Savings</div>
                    <div id="tSave" class="metric-value">‚Çπ0</div>
                </div>
            </div>
        </div>

        <!-- CHARTS -->
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">üìâ Cost Components</div>
                <div class="chart-container">
                    <canvas id="waterfallChart"></canvas>
                </div>
                <div class="description">Economic cost breakdown: Interest, Opportunity costs, and Withholding losses</div>
            </div>

            <div class="chart-card">
                <div class="chart-title">üìà Rent Projection</div>
                <div class="chart-container">
                    <canvas id="forwardRentChart"></canvas>
                </div>
                <div class="description">Market rent escalation over the lease tenure based on inflation</div>
            </div>

            <div class="chart-card">
                <div class="chart-title">‚ö° Break-Even Analysis</div>
                <div class="chart-container">
                    <canvas id="breakEvenChart"></canvas>
                </div>
                <div class="description">Savings under different risk scenarios - tests decision robustness</div>
            </div>

            <div class="chart-card">
                <div class="chart-title">üí∞ Cumulative Costs</div>
                <div class="chart-container">
                    <canvas id="cumulativeChart"></canvas>
                </div>
                <div class="description">Total accumulated costs - intersection shows break-even point</div>
            </div>
        </div>
    </div>

    <script>
        // ===== HELPERS =====
        const $ = id => document.getElementById(id);

        function cleanNumber(v) {
            return parseFloat((v || '').replace(/[,%‚Çπ\s]/g, '')) || 0;
        }

        function num(id) {
            return cleanNumber($(id).value);
        }

        function formatINR(n) {
            return '‚Çπ' + Math.round(Math.max(0, n || 0)).toLocaleString('en-IN');
        }

        function syncInput(id) {
            const input = $(id);
            const range = $(id + 'Range');
            if (range) input.value = range.value;
            calculate();
        }

        // ===== THEME =====
        function toggleTheme() {
            document.body.classList.toggle('light');
            const isDark = !document.body.classList.contains('light');
            $('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
            $('theme-icon').textContent = '‚òÄÔ∏è';
        }

        // ===== CHART INSTANCES =====
        let waterfallChart = null;
        let forwardRentChart = null;
        let breakEvenChart = null;
        let cumulativeChart = null;

        // ===== EMI CALCULATOR =====
        function emi(P, r, n) {
            if (r === 0 || n === 0) return P / n;
            return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
        }

        // ===== MAIN CALCULATION =====
        function calculate() {
            try {
                console.log('üîÑ Calculating...');

                const LEASE_AMOUNT = num('leaseAmount');
                const LOAN_AMOUNT = num('loanAmount');
                const OWN_FUNDS = Math.max(0, LEASE_AMOUNT - LOAN_AMOUNT);

                const LOAN_INTEREST_RATE = (num('loanRate') / 100) / 12;
                const LOAN_TENURE = Math.max(1, num('loanTenure'));
                const LEASE_TENURE = Math.max(1, num('leaseTenure'));

                const WITHHOLDING = Math.min(1, num('withholding') / 100);
                const REFUND_DELAY = num('refundDelay');

                const MAINTENANCE = num('maintenance');
                const MARKET_RENT = num('marketRent') || 1;

                const OPP_RATE = (num('oppRate') / 100) / 12;
                const RISK_PREMIUM = num('riskPremium') / 100;
                const RENT_INCREMENT = (num('rentIncrement') / 100) / 12;

                // ===== EMI & INTEREST =====
                const EMI = emi(LOAN_AMOUNT, LOAN_INTEREST_RATE, LOAN_TENURE);
                const totalInterest = Math.max(0, EMI * LOAN_TENURE - LOAN_AMOUNT);
                const monthlyLeaseCost = EMI + MAINTENANCE;

                // ===== WITHHOLDING =====
                const withholdingLoss = LEASE_AMOUNT * WITHHOLDING;

                // ===== OPPORTUNITY COSTS =====
                const ownOpp = OWN_FUNDS * (Math.pow(1 + OPP_RATE, LEASE_TENURE) - 1);

                let emiOpp = 0;
                for (let m = 1; m <= LEASE_TENURE; m++) {
                    const yearIndex = Math.floor((m - 1) / 12);
                    const adjustedRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    const extra = monthlyLeaseCost - adjustedRent;
                    if (extra > 0) {
                        emiOpp += extra * (Math.pow(1 + OPP_RATE, LEASE_TENURE - m + 1) - 1);
                    }
                }

                const delayCost = (LEASE_AMOUNT * (1 - WITHHOLDING)) * OPP_RATE * REFUND_DELAY;
                const totalEconomic = totalInterest + withholdingLoss + ownOpp + emiOpp + delayCost;

                const riskRent = (totalEconomic / LEASE_TENURE) * (1 + RISK_PREMIUM);
                const monthlySavings = MARKET_RENT - riskRent;
                const yearlySavings = monthlySavings * 12;
                const termSavings = monthlySavings * LEASE_TENURE;

                // ===== SCORE =====
                let score = MARKET_RENT > 0 ? (monthlySavings / MARKET_RENT) * 100 : 0;
                score = Math.max(0, Math.min(100, score));

                let color = '#f1c40f';
                let interpretation = 'üìä Balanced - Consider other factors';

                if (score < 5) {
                    color = '#ff4d4d';
                    interpretation = '‚ùå BUYING is more economical';
                } else if (score < 25) {
                    color = '#ff9f43';
                    interpretation = '‚ö†Ô∏è SLIGHT BUYING advantage';
                } else if (score < 50) {
                    color = '#f1c40f';
                    interpretation = 'üìä MARGINAL LEASING advantage';
                } else if (score < 75) {
                    color = '#2ecc71';
                    interpretation = '‚úÖ STRONG LEASING advantage';
                } else {
                    color = '#1abc9c';
                    interpretation = 'üéØ EXCELLENT LEASING advantage';
                }

                // ===== UPDATE GAUGE =====
                const gaugeDegrees = (score / 100) * 360;
                $('gauge').style.background = `conic-gradient(${color} ${gaugeDegrees}deg, #1a2a38 ${gaugeDegrees}deg)`;
                $('dial').style.color = color;
                $('dial').innerText = Math.round(score);

                $('interpretation').innerText = interpretation;

                // ===== UPDATE METRICS =====
                $('emiLabel').innerText = 'EMI: ' + formatINR(EMI);
                $('oppLabel').innerText = 'Opp Cost: ' + formatINR(ownOpp);
                $('riskLabel').innerText = 'Risk Rent: ' + formatINR(riskRent);

                $('mSave').innerText = formatINR(monthlySavings);
                $('ySave').innerText = formatINR(yearlySavings);
                $('tSave').innerText = formatINR(termSavings);

                console.log('‚úÖ Calculation complete');

                // ===== WATERFALL CHART DATA =====
                const waterfall_labels = ['Interest', 'Opp Cost', 'EMI Opp', 'Delay', 'Withholding'];
                const waterfall_data = [totalInterest, ownOpp, emiOpp, delayCost, withholdingLoss];

                if (!waterfallChart) {
                    waterfallChart = new Chart($('waterfallChart'), {
                        type: 'bar',
                        data: {
                            labels: waterfall_labels,
                            datasets: [{
                                label: 'Costs',
                                data: waterfall_data,
                                backgroundColor: ['#ff4d4d', '#9b59b6', '#f1c40f', '#3498db', '#ff6b6b'],
                                borderRadius: 4,
                                borderWidth: 0,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: v => formatINR(v),
                                        color: '#94a8bd'
                                    },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    waterfallChart.data.datasets[0].data = waterfall_data;
                    waterfallChart.update();
                }

                // ===== FORWARD RENT CHART DATA =====
                const rentSeries = [];
                const rentLabels = [];
                for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
                    const yearIndex = Math.floor((m - 1) / 12);
                    rentSeries.push(MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex));
                    rentLabels.push('M' + m);
                }

                if (!forwardRentChart) {
                    forwardRentChart = new Chart($('forwardRentChart'), {
                        type: 'line',
                        data: {
                            labels: rentLabels,
                            datasets: [{
                                label: 'Projected Rent',
                                data: rentSeries,
                                borderColor: '#4db3ff',
                                backgroundColor: 'rgba(77, 179, 255, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: v => formatINR(v),
                                        color: '#94a8bd'
                                    },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    forwardRentChart.data.labels = rentLabels;
                    forwardRentChart.data.datasets[0].data = rentSeries;
                    forwardRentChart.update();
                }

                // ===== BREAK-EVEN CHART DATA =====
                const riskAxis = [];
                const savingsAxis = [];
                for (let r = -20; r <= 20; r += 2) {
                    const simulatedRiskRent = riskRent * (1 + r / 100);
                    riskAxis.push(r + '%');
                    savingsAxis.push(MARKET_RENT - simulatedRiskRent);
                }

                if (!breakEvenChart) {
                    breakEvenChart = new Chart($('breakEvenChart'), {
                        type: 'line',
                        data: {
                            labels: riskAxis,
                            datasets: [{
                                label: 'Monthly Savings',
                                data: savingsAxis,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointBackgroundColor: '#2ecc71',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: v => formatINR(v),
                                        color: '#94a8bd'
                                    },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    breakEvenChart.data.labels = riskAxis;
                    breakEvenChart.data.datasets[0].data = savingsAxis;
                    breakEvenChart.update();
                }

                // ===== CUMULATIVE CHART DATA =====
                let cumulativeBuy = 0;
                let cumulativeLease = 0;
                const cumulativeBuyData = [];
                const cumulativeLeaseData = [];
                const cumulativeMonths = [];

                for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
                    cumulativeBuy += monthlyLeaseCost;
                    const yearIndex = Math.floor((m - 1) / 12);
                    cumulativeLease += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    cumulativeBuyData.push(cumulativeBuy);
                    cumulativeLeaseData.push(cumulativeLease);
                    cumulativeMonths.push('M' + m);
                }

                if (!cumulativeChart) {
                    cumulativeChart = new Chart($('cumulativeChart'), {
                        type: 'line',
                        data: {
                            labels: cumulativeMonths,
                            datasets: [
                                {
                                    label: 'Buy Cost',
                                    data: cumulativeBuyData,
                                    borderColor: '#ff4d4d',
                                    backgroundColor: 'rgba(255, 77, 77, 0.05)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                },
                                {
                                    label: 'Lease Cost',
                                    data: cumulativeLeaseData,
                                    borderColor: '#2ecc71',
                                    backgroundColor: 'rgba(46, 204, 113, 0.05)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'top' } },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: v => formatINR(v),
                                        color: '#94a8bd'
                                    },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    cumulativeChart.data.labels = cumulativeMonths;
                    cumulativeChart.data.datasets[0].data = cumulativeBuyData;
                    cumulativeChart.data.datasets[1].data = cumulativeLeaseData;
                    cumulativeChart.update();
                }

            } catch (error) {
                console.error('‚ùå Calculation error:', error);
            }
        }

        // ===== INITIAL LOAD =====
        console.log('üöÄ App started');
        window.addEventListener('load', () => {
            console.log('üìÑ Page loaded');
            calculate();
        });

        // Calculate on page load
        calculate();
    </script>

</body>

</html>